function onRealityBlur(){var a=reality;a.realityHasFocus=false;clearInterval(a.respondControlsTimer);clearTimeout(a.pauseMe);a.mouseDown=false;a.spinning=false;a.spinUpDown=0;a.spinLeftRight=0;a.rotateAroundFixed=false}function onRealityFocus(){var a=reality;if(startedReality==true){if(a.realityHasFocus==false){a.realityHasFocus=true;a.startRendering()}}}var reality=new function(){function rotate(a,b,c){var d=c;var e=a;var f=b;var g=e*Math.cos(d)-f*Math.sin(d);var h=f*Math.cos(d)+e*Math.sin(d);var i=new Array(2);i[0]=g;i[1]=h;return i}function rotate3D(a,b,c,d,e,f){var g=Math.cos(a);var h=Math.cos(b);var i=Math.cos(c);var j=Math.sin(a);var k=Math.sin(b);var l=Math.sin(c);var m=h*i;var n=j*k*i-g*l;var o=g*k*i+j*l;var p=h*l;var q=g*i+j*k*l;var r=-j*i+g*k*l;var s=-k;var t=j*h;var u=g*h;var v=new Array(3);v[0]=d*m+e*n+f*o;v[1]=d*p+e*q+f*r;v[2]=d*s+e*t+f*u;return v}function raysDirection(){var a=Math.sqrt(this.lookX*this.lookX+this.lookY*this.lookY+this.lookZ*this.lookZ);var b=1.25;var c=this.rotate3D(this.pitch,this.yaw,this.roll,-b,0,0);this.stepXacr=c[0];this.stepYacr=c[1];this.stepZacr=c[2];this.stepXdown=(this.lookY*this.stepZacr-this.lookZ*this.stepYacr)*b/a;this.stepYdown=(this.lookZ*this.stepXacr-this.lookX*this.stepZacr)*b/a;this.stepZdown=(this.lookX*this.stepYacr-this.lookY*this.stepXacr)*b/a;return}function getKnownBlock(modelId,chunkId,index,pauseTillLoaded,priority){if(this.loadingCounter<200||priority==true&&this.priorityLoadingCounter<40){var parentModelId=modelId;var socket=1;var dbname=this.parentDatabase;var newModel=false;if(isNaN(chunkId)){var url=chunkId;if(!this.blockRegisteredURL[modelId]){this.blockRegisteredURL[modelId]=[]}if(!this.blockRegisteredURL[modelId][url]||this.blockRegisteredURL[modelId][url]==false){if(!this.blockRegisteredURL[modelId]){this.blockRegisteredURL[modelId]=[]}this.blockRegisteredURL[modelId][url]=true;this.modelCounter++;modelId=this.modelCounter;var connectTo=url.split("?");if(!this.uniqueServer[connectTo[0]]){this.socketCnt++;this.uniqueServer[connectTo[0]]=this.socketCnt;this.socket[this.socketCnt]=io.connect(connectTo[0]);var socket=this.socketCnt;var dbname=connectTo[1].split("=")[1];this.uniqueModelDbPerServer[socket]=[];this.uniqueModelDbPerServer[socket][dbname]=true}else{var socket=this.uniqueServer[connectTo[0]];var dbname=connectTo[1].split("=")[1];if(!this.uniqueModelDbPerServer[socket][dbname]){this.uniqueModelDbPerServer[socket][dbname]=true;this.dbSocketCnt++;var dbSocketId=this.dbSocketCnt}else{}}this.modelSocket[modelId]=socket;this.modelDb[modelId]=dbname;newModel=true;this.blockRegistered[modelId]=[];this.myBlocks[modelId]=[];var chunkId=1}else{this.dataLoading=true;return}}var parentBlock=this.currentBlock;if(!this.blockRegistered[modelId][chunkId]){this.blockRegistered[modelId][chunkId]=true;var serverAjax=false;if(serverAjax==true){var strServe="http://127.0.0.1/rvolve/project/voxel/reality_serve.php?db=voxel_parent&chunk_id="+chunkId+"&model_id="+modelId;if(this.modelURL[modelId]){strServe=this.modelURL[modelId]+"="+chunkId}else{}var that=this;$.get(strServe,function(response){var block=eval(response);that.myBlocks[modelId][block[0]]=block;that.myBlocks[modelId][block[0]][that.modelIndex]=[];for(var cnt=0;cnt<that.indInChunk;cnt++){that.myBlocks[modelId][block[0]][that.modelIndex][cnt]=0}that.myBlocks[modelId][block[0]].modelId=modelId;if(url){that.myBlocks[parentModelId][parentBlock][that.modelIndex][index]=modelId;that.myBlocks[parentModelId][parentBlock][that.childIndex][index]=that.newModelConst;that.blockRegisteredURL[parentModelId][url]=false}that.blockCounter++;if(priority==true){that.priorityLoadingCounter--}that.loadingCounter--;that.dataLoaded=true;that.dataLoading=false;if(pauseTillLoaded==true){that.currentBlock=block[0]}})}else{var newConnection=false;if(this.modelSocket[modelId]){socket=this.modelSocket[modelId];dbname=this.modelDb[modelId]}if(this.uniqueModelDbPerServer[socket][dbname]){if(this.uniqueModelDbPerServer[socket][dbname]==true){newConnection=true;this.uniqueModelDbPerServer[socket][dbname]=false}}var that=this;var db=dbname;var myPriority=priority;var myurl=url;var myModelId=modelId;var myParentBlock=parentBlock;this.clientRequestId++;this.loadingCounter++;if(priority==true){this.priorityLoadingCounter++}this.dataLoading=true;this.waitingOnChunk[this.clientRequestId]=true;this.socket[socket].on("chunk_request_reply"+this.clientRequestId,function(data){var block=eval(data);if(that.waitingOnChunk[block[3]]==true){that.waitingOnChunk[block[3]]=false;that.myBlocks[myModelId][block[0]]=block;that.myBlocks[myModelId][block[0]][that.modelIndex]=[];for(var cnt=0;cnt<that.indInChunk;cnt++){that.myBlocks[myModelId][block[0]][that.modelIndex][cnt]=0}that.myBlocks[myModelId][block[0]].modelId=modelId;if(newModel==true){that.myBlocks[parentModelId][myParentBlock][that.modelIndex][index]=myModelId;that.myBlocks[parentModelId][myParentBlock][that.childIndex][index]=that.newModelConst;that.blockRegisteredURL[parentModelId][myurl]=false}that.blockCounter++;if(myPriority==true){that.priorityLoadingCounter--}that.loadingCounter--;that.dataLoaded=true;that.dataLoading=false;if(pauseTillLoaded==true){that.currentBlock=block[0]}}});if(newConnection==false){this.socket[socket].emit("chunk_request_"+db,{newConnection:newConnection,db:db,chunkId:chunkId,modelId:1,clientRequestId:this.clientRequestId,url:myurl})}else{this.socket[socket].emit("chunk_request",{newConnection:newConnection,db:db,chunkId:chunkId,modelId:1,clientRequestId:this.clientRequestId,url:myurl})}}}}}function precalcRay(a,b,c,d,e){this.parent=null;this.parent=[];this.currentBlock=this.magicBlock;this.currentModel=this.magicModel;this.modelList=null;this.modelList=[];this.modelList.push(this.currentModel);this.loopScaleMask=this.loopScaleOrigMask;this.edgeDetectMask=this.edgeDetectMaskOrig;var f=this.loopDetailOrig;var g=this.loopBlockOrig;var h=this.loopEdgeOrig;var i=this.invLoopBlockOrig;var j=this.loopStepOrig;var k=0;var l=0;var m=0;var n=false;var o=0;this.xShift=this.xShiftOrig;this.yShift=this.yShiftOrig;this.zShift=this.zShiftOrig;var p=Math.floor(Math.abs(this.eyeX));var q=Math.floor(Math.abs(this.eyeY));var r=Math.floor(Math.abs(this.eyeZ));var s=[];var t=[];var u=[];currentBlockMaskXcomp=p&this.edgeDetectMask;currentBlockMaskYcomp=q&this.edgeDetectMask;currentBlockMaskZcomp=r&this.edgeDetectMask;var v=[];var w=[];var x=[];var y=[];var z=[];var A=[];var B=[];var C=[];var D=[];var E=[];var F=[];var G=[];var H=[];var I=[];var J=[];var K=[];var L=[];var M=[];var N;if(this.dataLoaded==false||this.blockCounter==0){this.getKnownBlock(this.currentModel,this.magicBlock,0,true,false);return false}var O=this.raySpeedConst;var P=Math.floor(Math.floor(a*O));var Q=Math.floor(Math.floor(b*O));var R=Math.floor(Math.floor(c*O));var S=Math.floor(Math.abs(P));var T=Math.floor(Math.abs(Q));var U=Math.floor(Math.abs(R));var V,W;var X,Y;var Z,$;if(P>0){V=j;W=j}else{V=-j;W=0}if(Q>0){X=j;Y=j}else{X=-j;Y=0}if(R>0){Z=j;$=j}else{Z=-j;$=0}if(this.framesDelay>500){}k=0;l=0;m=0;var _=100;var ab=p;var bb=q;var cb=r;var p=Math.floor(Math.abs(this.eyeX));var q=Math.floor(Math.abs(this.eyeY));var r=Math.floor(Math.abs(this.eyeZ));var db=p&f;var eb=q&f;var fb=r&f;var gb=false;var hb=false;var ib=false;var jb=this.eyeX;var kb=this.eyeY;var lb=this.eyeZ;var mb=0;var nb=1;k=0;l=0;m=0;var db=p&f;var eb=q&f;var fb=r&f;var _=100;var ob=1e3;if(Math.abs(R)<ob){var pb=Math.floor(_*Z);var qb=Math.floor(_*Z);var rb=Math.floor(Z)}else{var sb=(Z-R)/R;var pb=Math.floor(P*sb+P);var qb=Math.floor(Q*sb+Q);var rb=Math.floor(Z)}if(Math.abs(P)<ob){var tb=Math.floor(V);var ub=Math.floor(_*V);var vb=Math.floor(_*V)}else{var sb=(V-P)/P;var tb=Math.floor(V);var ub=Math.floor(Q*sb+Q);var vb=Math.floor(R*sb+R)}if(Math.abs(Q)<ob){var wb=Math.floor(_*X);var xb=Math.floor(X);var yb=Math.floor(_*X)}else{var sb=(X-Q)/Q;var wb=Math.floor(P*sb+P);var xb=Math.floor(X);var yb=Math.floor(R*sb+R)}this.eachStepXDX[d][e]=tb;this.eachStepXDY[d][e]=ub;this.eachStepXDZ[d][e]=vb;this.eachStepYDX[d][e]=wb;this.eachStepYDY[d][e]=xb;this.eachStepYDZ[d][e]=yb;this.eachStepZDX[d][e]=pb;this.eachStepZDY[d][e]=qb;this.eachStepZDZ[d][e]=rb;var mb=0;var nb=1;while(nb!=0&&mb<this.maxScales){mb++;var zb=(p&this.loopScaleMask)>>this.xShift;var Ab=(q&this.loopScaleMask)>>this.yShift;var Bb=(r&this.loopScaleMask)>>this.zShift;var Cb=zb+Ab+Bb;if(mb>2){}nb=this.myBlocks[this.currentModel][this.currentBlock][this.colours][Cb];if(nb!=0){var Db=this.myBlocks[this.currentModel][this.currentBlock][this.childIndex][Cb];if(isNaN(Db)){this.getKnownBlock(this.currentModel,Db,Cb,false,false);Db=this.nullIndex}if(Db==this.newModelConst){var Eb=this.currentModel;this.currentModel=this.myBlocks[this.currentModel][this.currentBlock][this.modelIndex][Cb];Db=this.firstBlock}else{var Eb=false}if(Db>0){if(this.myBlocks[this.currentModel][Db]){this.currentBlock=Db;o++;O=O>>this.scaleShift;P=P>>this.scaleShift;Q=Q>>this.scaleShift;R=R>>this.scaleShift;j=j>>this.scaleShift;g=g>>this.scaleShift;g=g+this.addAfterShiftRight;h=h>>this.scaleShift;i=i>>this.scaleShift;this.loopScaleMask=this.loopScaleMask>>this.scaleShift;this.xShift-=this.scaleShift;this.yShift-=this.scaleShift;this.zShift-=this.scaleShift;this.edgeDetectMask=this.edgeDetectMask>>this.scaleShift;this.edgeDetectMask=this.edgeDetectMask+this.addAfterShiftRight;currentBlockMaskXcomp=p&this.edgeDetectMask;currentBlockMaskYcomp=q&this.edgeDetectMask;currentBlockMaskZcomp=r&this.edgeDetectMask;pb=pb>>this.scaleShift;qb=qb>>this.scaleShift;rb=rb>>this.scaleShift;wb=wb>>this.scaleShift;xb=xb>>this.scaleShift;yb=yb>>this.scaleShift;tb=tb>>this.scaleShift;ub=ub>>this.scaleShift;vb=vb>>this.scaleShift;V=V>>this.scaleShift;X=X>>this.scaleShift;Z=Z>>this.scaleShift;W=W>>this.scaleShift;Y=Y>>this.scaleShift;$=$>>this.scaleShift;f=f>>this.scaleShift;db=p&f;eb=q&f;fb=r&f}else{this.getKnownBlock(this.currentModel,Db,Cb,false,false);nb=0}}else{nb=0}}}var ob=100;if(Math.abs(R)<ob){var Fb=Math.floor(_*Z);var Gb=Math.floor(_*Z);var Hb=Math.floor($)}else{sb=($-fb-R)/R;var Fb=Math.floor(db+P+P*sb);var Gb=Math.floor(eb+Q+Q*sb);var Hb=Math.floor(fb+R+R*sb);if(this.framesDelay>500){}}if(Math.abs(P)<ob){var Ib=Math.floor(W);var Jb=Math.floor(_*V);var Kb=Math.floor(_*V)}else{sb=(W-db-P)/P;var Ib=Math.floor(db+P+P*sb);var Jb=Math.floor(eb+Q+Q*sb);var Kb=Math.floor(fb+R+R*sb)}if(Math.abs(Q)<ob){var Lb=Math.floor(_*X);var Mb=Math.floor(_*X);var Nb=Math.floor(Y)}else{sb=(Y-eb-Q)/Q;var Lb=Math.floor(db+P+P*sb);var Mb=Math.floor(eb+Q+Q*sb);var Nb=Math.floor(fb+R+R*sb)}if(this.framesDelay>500){}this.firstStepXDX[d][e]=Ib;this.firstStepXDY[d][e]=Jb;this.firstStepXDZ[d][e]=Kb;this.firstStepYDX[d][e]=Lb;this.firstStepYDY[d][e]=Mb;this.firstStepYDZ[d][e]=Nb;this.firstStepZDX[d][e]=Fb;this.firstStepZDY[d][e]=Gb;this.firstStepZDZ[d][e]=Hb}function stepThrough(a,c,d,e,f,h){if(this.framesDelay>500){alert("SX="+e+" SY="+f+" New Ray x:"+a+" Ray y:"+c+" Ray z:"+d)}this.parent=null;this.parent=[];this.currentBlock=this.magicBlock;this.currentModel=this.magicModel;this.modelList=null;this.modelList=[];this.modelList.push(this.currentModel);this.loopScaleMask=this.loopScaleOrigMask;this.edgeDetectMask=this.edgeDetectMaskOrig;var i=this.loopDetailOrig;var j=this.loopBlockOrig;var k=this.loopEdgeOrig;var l=this.invLoopBlockOrig;var m=this.loopStepOrig;var n=0;var o=0;var p=0;var q=false;var s=0;var t=this.pixelWidth;var u=this.pixelRate;this.xShift=this.xShiftOrig;this.yShift=this.yShiftOrig;this.zShift=this.zShiftOrig;var v=Math.floor(Math.abs(this.eyeX));var w=Math.floor(Math.abs(this.eyeY));var x=Math.floor(Math.abs(this.eyeZ));var y=[];var z=[];var A=[];currentBlockMaskXcomp=v&this.edgeDetectMask;currentBlockMaskYcomp=w&this.edgeDetectMask;currentBlockMaskZcomp=x&this.edgeDetectMask;y.push(currentBlockMaskXcomp);z.push(currentBlockMaskYcomp);A.push(currentBlockMaskZcomp);var B=[];var C=[];var D=[];var E=[];var F=[];var G=[];var H=[];var I=[];var J=[];var K=[];var L=[];var M=[];var N=[];var O=[];var P=[];var Q=[];var R=[];var S=[];var T;if(this.dataLoaded==false||this.blockCounter==0){this.getKnownBlock(this.currentModel,this.magicBlock,0,true,h);return false}var U=this.raySpeedConst;var V=Math.floor(Math.floor(a));var W=Math.floor(Math.floor(c));var X=Math.floor(Math.floor(d));var Y,Z;var $,_;var ab,bb;if(V>0){Y=m;Z=m}else{Y=-m;Z=0}if(W>0){$=m;_=m}else{$=-m;_=0}if(X>0){ab=m;bb=m}else{ab=-m;bb=0}if(this.framesDelay>500){console.log("rayX:"+a+" deepX:"+V+" rayY:"+c+" deepY:"+W+" rayZ:"+d+" deepZ:"+X+" StepZ="+ab)}n=0;o=0;p=0;var cb=v&i;var db=w&i;var eb=x&i;var fb=100;var gb=this.curEachStepXDX;var hb=this.curEachStepXDY;var ib=this.curEachStepXDZ;var jb=this.curEachStepYDX;var kb=this.curEachStepYDY;var lb=this.curEachStepYDZ;var mb=this.curEachStepZDX;var nb=this.curEachStepZDY;var ob=this.curEachStepZDZ;var pb=this.curFirstStepXDX;var qb=this.curFirstStepXDY;var rb=this.curFirstStepXDZ;var sb=this.curFirstStepYDX;var tb=this.curFirstStepYDY;var ub=this.curFirstStepYDZ;var vb=this.curFirstStepZDX;var wb=this.curFirstStepZDY;var xb=this.curFirstStepZDZ;if(this.framesDelay>500){if(!pb){console.log("Screen XY:"+e+" "+f+" First step XDX"+pb+" "+qb+" "+rb);console.log("First step YDX"+sb+" "+tb+" "+ub);console.log("First step ZDX"+vb+" "+wb+" "+xb)}}var yb=v;var zb=w;var Ab=x;var Bb=0;var Cb=1;while(Cb!=0&&Bb<this.maxScales){Bb++;var Db=(v&this.loopScaleMask)>>this.xShift;var Eb=(w&this.loopScaleMask)>>this.yShift;var Fb=(x&this.loopScaleMask)>>this.zShift;var Gb=Db+Eb+Fb;if(Bb>2){}Cb=this.myBlocks[this.currentModel][this.currentBlock][this.colours][Gb];if(Cb!=0){var Hb=this.myBlocks[this.currentModel][this.currentBlock][this.childIndex][Gb];if(isNaN(Hb)){this.getKnownBlock(this.currentModel,Hb,Gb,false,h);Hb=this.nullIndex}if(Hb==this.newModelConst){var Ib=this.currentModel;this.currentModel=this.myBlocks[this.currentModel][this.currentBlock][this.modelIndex][Gb];Hb=this.firstBlock}else{var Ib=false}if(Hb>0){if(this.myBlocks[this.currentModel][Hb]){this.parent.push(this.currentBlock);this.currentBlock=Hb;s++;if(Ib!=false){this.modelList.push(Ib)}else{this.modelList.push(this.currentModel)}U=U>>this.scaleShift;V=V>>this.scaleShift;W=W>>this.scaleShift;X=X>>this.scaleShift;m=m>>this.scaleShift;j=j>>this.scaleShift;j=j+this.addAfterShiftRight;k=k>>this.scaleShift;l=l>>this.scaleShift;u=u>>this.scaleShift;this.loopScaleMask=this.loopScaleMask>>this.scaleShift;this.xShift-=this.scaleShift;this.yShift-=this.scaleShift;this.zShift-=this.scaleShift;this.edgeDetectMask=this.edgeDetectMask>>this.scaleShift;this.edgeDetectMask=this.edgeDetectMask+this.addAfterShiftRight;y.push(currentBlockMaskXcomp);z.push(currentBlockMaskYcomp);A.push(currentBlockMaskZcomp);currentBlockMaskXcomp=v&this.edgeDetectMask;currentBlockMaskYcomp=w&this.edgeDetectMask;currentBlockMaskZcomp=x&this.edgeDetectMask;B.push(mb);C.push(nb);D.push(ob);E.push(jb);F.push(kb);G.push(lb);H.push(gb);I.push(hb);J.push(ib);mb=mb>>this.scaleShift;nb=nb>>this.scaleShift;ob=ob>>this.scaleShift;jb=jb>>this.scaleShift;kb=kb>>this.scaleShift;lb=lb>>this.scaleShift;gb=gb>>this.scaleShift;hb=hb>>this.scaleShift;ib=ib>>this.scaleShift;Y=Y>>this.scaleShift;$=$>>this.scaleShift;ab=ab>>this.scaleShift;Z=Z>>this.scaleShift;_=_>>this.scaleShift;bb=bb>>this.scaleShift}else{this.getKnownBlock(this.currentModel,Hb,Gb,false,h);Cb=0}}else{Cb=0}}}var e=Math.floor(v)&j;var f=Math.floor(w)&j;var Jb=Math.floor(x)&j;var Kb=e+vb;var Lb=f+wb;var Mb=Jb+xb;var Nb=e+pb;var Ob=f+qb;var Pb=Jb+rb;var Qb=e+sb;var Rb=f+tb;var Sb=Jb+ub;var Tb=false;var Ub=false;var Vb=false;var Wb=this.eyeX;var Xb=this.eyeY;var Yb=this.eyeZ;var Zb=0;var $b=false;var _b=false;var ac=false;var bc=0;var cc=Kb;var dc=Lb;var ec=Mb;var fc=Nb;var gc=Ob;var hc=Pb;var ic=Qb;var jc=Rb;var kc=Sb;var v=Math.floor(v)&j;var w=Math.floor(w)&j;var x=Math.floor(x)&j;var lc=Math.abs(cc-Wb)+Math.abs(ec-Yb)+Math.abs(dc-Xb);var mc=Math.abs(fc-Wb)+Math.abs(hc-Yb)+Math.abs(gc-Xb);var nc=Math.abs(ic-Wb)+Math.abs(kc-Yb)+Math.abs(jc-Xb);if(lc<mc){if(lc<nc){Kb=cc;Lb=dc;Mb=ec;Tb=true;Wb=Kb;Xb=Lb;Yb=Mb;x=x+ab}else{Qb=ic;Rb=jc;Sb=kc;Vb=true;Wb=Qb;Xb=Rb;Yb=Sb;w=w+$}}else{if(mc<nc){Nb=fc;Ob=gc;Pb=hc;Ub=true;Wb=Nb;Xb=Ob;Yb=Pb;v=v+Y}else{Qb=ic;Rb=jc;Sb=kc;Vb=true;Wb=Qb;Xb=Rb;Yb=Sb;w=w+$}}var oc=0;var pc=false;var qc="";var rc=false;var sc=false;var tc=false;var uc=[];var vc=[];var wc=[];var xc=this.myMaxDepth;if(this.framesDelay>500){console.log("Starting scale stepX:"+Y)}while(Zb<xc&&Cb==0&&oc<this.maxDepth){oc++;if(oc>40){var yc=true}if(this.framesDelay>500){console.log("x:"+v+" "+w+" "+x)}if(v<0||w<0||x<0){if(this.framesDelay>500){console.log("end of line - out of bounds");this.framesDelay=0}this.parent=null;this.modelList=null;B=null;C=null;D=null;E=null;F=null;G=null;H=null;I=null;J=null;K=null;L=null;M=null;N=null;O=null;P=null;Q=null;R=null;S=null;y=null;z=null;A=null;this.rayWentDist=Zb;this.rayWentX=Wb;this.rayWentY=Xb;this.rayWentZ=Yb;this.moveOut+=s;return 0}ac=true;while(ac==true){ac=false;var zc=v&this.edgeDetectMask;var Ac=w&this.edgeDetectMask;var Bc=x&this.edgeDetectMask;if(zc!=currentBlockMaskXcomp||Ac!=currentBlockMaskYcomp||Bc!=currentBlockMaskZcomp){var Cc=this.parent.pop();if(Cc){this.currentBlock=Cc;ac=true;pc=true;U=U<<this.scaleShift;m=m<<this.scaleShift;this.loopScaleMask=this.loopScaleMask<<this.scaleShift;this.xShift+=this.scaleShift;this.yShift+=this.scaleShift;this.zShift+=this.scaleShift;this.edgeDetectMask=this.edgeDetectMask-this.addAfterShiftRight;this.edgeDetectMask=this.edgeDetectMask<<this.scaleShift;u=u<<this.scaleShift;this.currentModel=this.modelList.pop();if(this.framesDelay>500){alert("Scaling up. Just retrieved current model"+this.currentModel)}Ub=true;Vb=true;Tb=true;Y=Y<<this.scaleShift;$=$<<this.scaleShift;ab=ab<<this.scaleShift;s--;j=j-this.addAfterShiftRight;j=j<<this.scaleShift;k=k<<this.scaleShift;var Dc=1;var Ec=Math.floor(Wb);var Fc=Math.floor(Xb);var Gc=Math.floor(Yb);var Hc=0;var Dc=20;if((Ec&l)>l-Dc){if(Y>0){Ec=Ec+1+(l-(Ec&l))}else{}}if((Fc&l)>l-Dc){if($>0){Fc=Fc+1+(l-(Fc&l))}else{}}if((Gc&l)>l-Dc){if(ab>0){Gc=Gc+1+(l-(Gc&l))}else{}}if((Ec&l)<Dc){if(Y>0){}else{Ec=Ec-(Ec&l)-1}}if((Fc&l)<Dc){if($>0){}else{Fc=Fc-(Fc&l)-1}}if((Gc&l)<Dc){if(ab>0){}else{Gc=Gc-(Gc&l)-1}}if(tc==false){v=Ec&j;w=Fc&j;x=Gc&j}else{uc.push(v);vc.push(w);wc.push(x);v=v&j;w=w&j;x=x&j}Wb=Ec;Xb=Fc;Yb=Gc;if(K.length<=0){var Ic=0;var Jc=4;var Kc=false;var Dc=20;if(ob>0){var Lc=x+k-Dc;if(this.framesDelay>500){console.log("Myzz "+Mb+" = "+Lc)}while(Mb<Lc&&Ic<Jc){Kb=Kb+mb;Lb=Lb+nb;Mb=Mb+ob;if(this.framesDelay>500){console.log("Each step ZDX = "+mb+"Each step ZDY = "+nb+"Each step ZDZ = "+ob);console.log("Move forward pos step till "+Mb+" = "+Lc)}Kc=true;Ic++}if(this.framesDelay>500){console.log("Done pos step myZ="+Mb+"  compareZ="+Lc+" z:"+x+" loop edge: "+k)}}else{var Lc=x+Dc;while(Mb>Lc&&Ic<Jc){Kb=Kb+mb;Lb=Lb+nb;Mb=Mb+ob;if(this.framesDelay>500){console.log("Move forward till "+Mb+" = "+Lc)}Kc=true;Ic++}if(this.framesDelay>500){console.log("Done myZ="+Mb+"  compareZ="+Lc)}}var Ic=0;var Kc=false;if(gb>0){var Mc=v+k-Dc;while(Nb<Mc&&Ic<Jc){Nb=Nb+gb;Ob=Ob+hb;Pb=Pb+ib;Kc=true;Ic++}}else{var Mc=v+Dc;while(Nb>Mc&&Ic<Jc){Nb=Nb+gb;Ob=Ob+hb;Pb=Pb+ib;Kc=true;Ic++}}var Ic=0;var Kc=false;if(kb>0){var Nc=w+k-Dc;while(Rb<Nc&&Ic<Jc){Qb=Qb+jb;Rb=Rb+kb;Sb=Sb+lb;Kc=true;Ic++}}else{var Nc=w+Dc;while(Rb>Nc&&Ic<Jc){Qb=Qb+jb;Rb=Rb+kb;Sb=Sb+lb;Kc=true;Ic++}}mb=B.pop();nb=C.pop();ob=D.pop();jb=E.pop();kb=F.pop();lb=G.pop();gb=H.pop();hb=I.pop();ib=J.pop();if(gb>0){if(Nb>Wb){Nb=Nb-gb;Ob=Ob-hb;Pb=Pb-ib}}else{if(Nb<Wb){Nb=Nb-gb;Ob=Ob-hb;Pb=Pb-ib}}if(ob>0){if(Mb>Yb){Kb=Kb-mb;Lb=Lb-nb;Mb=Mb-ob}}else{if(Mb<Yb){Kb=Kb-mb;Lb=Lb-nb;Mb=Mb-ob}}if(kb>0){if(Rb>Xb){Qb=Qb-jb;Rb=Rb-kb;Sb=Sb-lb}}else{if(Rb<Xb){Qb=Qb-jb;Rb=Rb-kb;Sb=Sb-lb}}}else{mb=B.pop();nb=C.pop();ob=D.pop();jb=E.pop();kb=F.pop();lb=G.pop();gb=H.pop();hb=I.pop();ib=J.pop();Kb=K.pop();Lb=L.pop();Mb=M.pop();Nb=Q.pop();Ob=R.pop();Pb=S.pop();Qb=N.pop();Rb=O.pop();Sb=P.pop();var Ic=0;var Jc=4;var Dc=1;if(ob>0){while(Mb<Yb-Dc&&Ic<Jc){Kb=Kb+mb;Lb=Lb+nb;Mb=Mb+ob;Ic++}if(Mb>Yb&&Ic>0){Kb=Kb-mb;Lb=Lb-nb;Mb=Mb-ob}}else{while(Mb>Yb+Dc&&Ic<Jc){Kb=Kb+mb;Lb=Lb+nb;Mb=Mb+ob;Ic++}if(Mb<Yb&&Ic>0){Kb=Kb-mb;Lb=Lb-nb;Mb=Mb-ob}}Ic=0;if(gb>0){while(Nb<Wb-Dc&&Ic<Jc){Nb=Nb+gb;Ob=Ob+hb;Pb=Pb+ib;Ic++}if(Nb>Wb&&Ic>0){Nb=Nb-gb;Ob=Ob-hb;Pb=Pb-ib}}else{while(Nb>Wb+Dc&&Ic<Jc){Nb=Nb+gb;Ob=Ob+hb;Pb=Pb+ib;Ic++}if(Nb<Wb&&Ic>0){Nb=Nb-gb;Ob=Ob-hb;Pb=Pb-ib}}Ic=0;if(kb>0){while(Rb<Xb-Dc&&Ic<Jc){Qb=Qb+jb;Rb=Rb+kb;Sb=Sb+lb;Ic++}if(Rb>Xb&&Ic>0){Qb=Qb-jb;Rb=Rb-kb;Sb=Sb-lb}}else{while(Rb>Xb+Dc&&Ic<Jc){Qb=Qb+jb;Rb=Rb+kb;Sb=Sb+lb;Ic++}if(Rb<Xb&&Ic>0){Qb=Qb-jb;Rb=Rb-kb;Sb=Sb-lb}}}Dc=6;var Oc;l=(l<<this.scaleShift)+3;currentBlockMaskXcomp=y.pop();currentBlockMaskYcomp=z.pop();currentBlockMaskZcomp=A.pop();rc=false;this.moveInOut++;this.moveOut++}else{if(this.framesDelay>500){console.log("end of line - out of world");this.framesDelay=0}this.depthAverage++;if(this.wrapWorld==false){this.parent=null;this.modelList=null;B=null;C=null;D=null;E=null;F=null;G=null;H=null;I=null;J=null;K=null;L=null;M=null;N=null;O=null;P=null;Q=null;R=null;S=null;y=null;z=null;A=null;this.moveOut+=s;this.rayWentDist=Zb;this.rayWentX=Wb;this.rayWentY=Xb;this.rayWentZ=Yb;return 0}}}}var Db=(v&this.loopScaleMask)>>this.xShift;var Eb=(w&this.loopScaleMask)>>this.yShift;var Fb=(x&this.loopScaleMask)>>this.zShift;var Gb=Db+Eb+Fb;if(!this.myBlocks[this.currentModel][this.currentBlock]){alert("mod"+this.currentModel+" block"+this.currentBlock)}else{Cb=this.myBlocks[this.currentModel][this.currentBlock][this.colours][Gb]}if(this.twomap==true){var Pc=2;var Qc=50;var Rc=50;var Sc=19;this.bufferContext.fillText(v,(v>>Sc)+Qc,(x>>Sc)+Rc);aminx=(v>>Sc)+Qc;aminz=(x>>Sc)+Rc;amaxx=(v+Math.abs(Y)>>Sc)+Qc;amaxz=(x+Math.abs(ab)>>Sc)+Rc;for(ax=aminx;ax<amaxx;ax++){for(az=aminz;az<amaxz;az++){var Tc=az*this.width+ax<<Pc;switch(s){case 0:var Uc=128;break;case 1:var Uc=64;break;case 2:var Uc=32;break;default:var Uc=16;break}if(Uc==64||Uc==32||Uc==128||Uc==16){r=Uc;g=Uc;b=Uc;this.imageData.data[Tc]=r;this.imageData.data[Tc+1]=g;this.imageData.data[Tc+2]=b;this.imageData.data[Tc+3]=128}}}ax=(Nb>>Sc)+Qc;az=(Pb>>Sc)+Rc;var Tc=az*this.width+ax<<Pc;r=0;g=255;b=255;this.imageData.data[Tc]=r;this.imageData.data[Tc+1]=g;this.imageData.data[Tc+2]=b;this.imageData.data[Tc+3]=255;ax=(Kb>>Sc)+Qc;az=(Mb>>Sc)+Rc;var Tc=az*this.width+ax<<Pc;r=255;g=0;b=255;this.imageData.data[Tc]=r;this.imageData.data[Tc+1]=g;this.imageData.data[Tc+2]=b;this.imageData.data[Tc+3]=255;ax=(this.eyeX>>Sc)+Qc;az=(this.eyeZ>>Sc)+Rc;var Tc=az*this.width+ax<<Pc;r=255;g=0;b=0;this.imageData.data[Tc]=r;this.imageData.data[Tc+1]=g;this.imageData.data[Tc+2]=b;this.imageData.data[Tc+3]=255;if(this.framesDelay>500){this.bufferContext.putImageData(this.imageData,0,0);ax=this.loopEdgeOrig*1;az=0;this.bufferContext.fillText(ax,(ax>>Sc)+Qc,(az>>Sc)+Rc);ax=this.loopEdgeOrig*3;az=0;this.bufferContext.fillText(ax,(ax>>Sc)+Qc,(az>>Sc)+Rc);ax=0;az=this.loopEdgeOrig*1;this.bufferContext.fillText(az,(ax>>Sc)+Qc,(az>>Sc)+Rc);ax=0;az=this.loopEdgeOrig*3;this.bufferContext.fillText(az,(ax>>Sc)+Qc,(az>>Sc)+Rc);this.outputContext.drawImage(this.buffer,0,0,this.outputWidth,this.outputHeight)}}if(this.framesDelay>500){console.log("px:"+Wb+" "+Xb+" "+Yb);var Db=(v&this.loopScaleMask)>>this.xShift;var Eb=(w&this.loopScaleMask)>>this.xShift;var Fb=(x&this.loopScaleMask)>>this.xShift;console.log("Current model:"+this.currentModel);console.log("Current Block:"+this.currentBlock);console.log("An index check:"+Db+" "+Eb+" "+Fb)}if(this.framesDelay>500){console.log("px:"+Wb+" "+Xb+" "+Yb);console.log("x:"+v+" "+w+" "+x);console.log("POINT PLOTTED");alert("point")}var Vc=false;if(this.framesDelay>500){console.log("currentPixelWidth"+t+" Loop block="+j)}if(Cb!=0&&t<k){var Hb=this.myBlocks[this.currentModel][this.currentBlock][this.childIndex][Gb];if(isNaN(Hb)){this.getKnownBlock(this.currentModel,Hb,Gb,false,h);Hb=this.nullIndex}if(Hb==this.newModelConst){var Ib=this.currentModel;this.currentModel=this.myBlocks[this.currentModel][this.currentBlock][this.modelIndex][Gb];Hb=this.firstBlock}else{var Ib=false}if(Hb>0){if(this.myBlocks[this.currentModel][Hb]){this.parent.push(this.currentBlock);this.currentBlock=Hb;if(Ib!=false){this.modelList.push(Ib)}else{this.modelList.push(this.currentModel)}bc=Cb;s++;U=U>>this.scaleShift;m=m>>this.scaleShift;j=j>>this.scaleShift;j=j+this.addAfterShiftRight;k=k>>this.scaleShift;l=l>>this.scaleShift;var Dc=1;var Wc=k-1;var Hc=0;var Xc=0;var Yc=0;var Zc=0;var Ec=Math.floor(Wb);var Fc=Math.floor(Xb);var Gc=Math.floor(Yb);var $c=false;this.edgeDetectMask=this.edgeDetectMask>>this.scaleShift;this.edgeDetectMask=this.edgeDetectMask+this.addAfterShiftRight;y.push(currentBlockMaskXcomp);z.push(currentBlockMaskYcomp);A.push(currentBlockMaskZcomp);currentBlockMaskXcomp=v&this.edgeDetectMask;currentBlockMaskYcomp=w&this.edgeDetectMask;currentBlockMaskZcomp=x&this.edgeDetectMask;if(tc==false){v=Ec&j;w=Fc&j;x=Gc&j}else{if(uc.length>0){v=uc.pop();w=vc.pop();x=wc.pop()}else{v=Ec&j;w=Fc&j;x=Gc&j;$c=true}}if(Ec<0){v=-1}if(Fc<0){w=-1}if(Gc<0){x=-1}this.loopScaleMask=this.loopScaleMask>>this.scaleShift;this.xShift-=this.scaleShift;this.yShift-=this.scaleShift;this.zShift-=this.scaleShift;var Dc=20;if((Ec&l)>l-Dc){if(Y>0){Ec=Ec+1+(l-(Ec&l))}else{}}if((Fc&l)>l-Dc){if($>0){Fc=Fc+1+(l-(Fc&l))}else{}}if((Gc&l)>l-Dc){if(ab>0){Gc=Gc+1+(l-(Gc&l))}else{}}if((Ec&l)<Dc){if(Y>0){}else{Ec=Ec-(Ec&l)-1}}if((Fc&l)<Dc){if($>0){}else{Fc=Fc-(Fc&l)-1}}if((Gc&l)<Dc){if(ab>0){}else{Gc=Gc-(Gc&l)-1}}Nb=Math.floor(Nb);Ob=Math.floor(Ob);Pb=Math.floor(Pb);Qb=Math.floor(Qb);Rb=Math.floor(Rb);Sb=Math.floor(Sb);Kb=Math.floor(Kb);Lb=Math.floor(Lb);Mb=Math.floor(Mb);if(tc==false){v=Ec&j;w=Fc&j;x=Gc&j}else{if($c==true){v=Ec&j;w=Fc&j;x=Gc&j}}if(Ec<0){v=-1}if(Fc<0){w=-1}if(Gc<0){x=-1}var Dc=6;var _c=0;var ad=l>>this.scaleShift;var bd=0;var cd=false;var dd=false;var ed=false;B.push(mb);C.push(nb);D.push(ob);E.push(jb);F.push(kb);G.push(lb);H.push(gb);I.push(hb);J.push(ib);mb=mb>>this.scaleShift;nb=nb>>this.scaleShift;ob=ob>>this.scaleShift;jb=jb>>this.scaleShift;kb=kb>>this.scaleShift;lb=lb>>this.scaleShift;gb=gb>>this.scaleShift;hb=hb>>this.scaleShift;ib=ib>>this.scaleShift;u=u>>this.scaleShift;Y=Y>>this.scaleShift;$=$>>this.scaleShift;ab=ab>>this.scaleShift;K.push(Kb);L.push(Lb);M.push(Mb);Q.push(Nb);R.push(Ob);S.push(Pb);N.push(Qb);O.push(Rb);P.push(Sb);Ub=true;Vb=true;Tb=true;if(this.framesDelay>500){console.log("Before move forwards myZX:"+Kb+" "+Lb+" "+Mb+" myXX:"+Nb+" "+Ob+" "+Pb+" myYX:"+Qb+" "+Rb+" "+Sb+" ");console.log("fpz:"+Gc+" fpy:"+Fc+" fpx:"+Ec)}var Kc=false;var Ic=0;var Jc=4;var fd=0;var Dc=0;Wb=Ec;Xb=Fc;Yb=Gc;if(ob>0){if(Mb<Yb){while(Mb<Yb&&Ic<Jc){Kb=Kb+mb;Lb=Lb+nb;Mb=Mb+ob;Kc=true;Ic++}if(Mb>Yb+Dc&&Kc==true){Kb=Kb-mb;Lb=Lb-nb;Mb=Mb-ob}}else{while(Mb>Yb+Dc&&Ic<Jc){Kb=Kb-mb;Lb=Lb-nb;Mb=Mb-ob;Kc=true;Ic++}}}else{if(Mb>Yb){while(Mb>Yb&&Ic<Jc){Kb=Kb+mb;Lb=Lb+nb;Mb=Mb+ob;Kc=true;Ic++}if(Mb<Yb-Dc&&Kc==true){Kb=Kb-mb;Lb=Lb-nb;Mb=Mb-ob}}else{while(Mb<Yb-Dc&&Ic<Jc){Kb=Kb-mb;Lb=Lb-nb;Mb=Mb-ob;Ic++}}}var Ic=0;var Kc=false;var fd=0;if(gb>0){if(Nb<Wb){while(Nb<Wb&&Ic<Jc){Nb=Nb+gb;Ob=Ob+hb;Pb=Pb+ib;Ic++;Kc=true}if(Nb>Wb+Dc&&Kc==true){Nb=Nb-gb;Ob=Ob-hb;Pb=Pb-ib}}else{while(Nb>Wb+Dc&&Ic<Jc){Nb=Nb-gb;Ob=Ob-hb;Pb=Pb-ib;Kc=true;Ic++}}}else{if(Nb>Wb){while(Nb>Wb&&Ic<Jc){Nb=Nb+gb;Ob=Ob+hb;Pb=Pb+ib;Kc=true;Ic++}if(Nb<Wb-Dc&&Kc==true){Nb=Nb-gb;Ob=Ob-hb;Pb=Pb-ib}}else{while(Nb<Wb-Dc&&Ic<Jc){Nb=Nb-gb;Ob=Ob-hb;Pb=Pb-ib;Kc=true;Ic++}}}var Ic=0;var Kc=false;var fd=0;var Ic=0;var Kc=false;if(kb>0){if(Rb<Xb){while(Rb<Xb&&Ic<Jc){Qb=Qb+jb;Rb=Rb+kb;Sb=Sb+lb;Kc=true;Ic++}if(Rb>Xb+Dc&&Kc==true){Qb=Qb-jb;Rb=Rb-kb;Sb=Sb-lb}}else{while(Rb>Xb+Dc&&Ic<Jc){Qb=Qb-jb;Rb=Rb-kb;Sb=Sb-lb;Kc=true;Ic++}}}else{if(Rb>Xb){while(Rb>Xb&&Ic<Jc){Qb=Qb+jb;Rb=Rb+kb;Sb=Sb+lb;Kc=true;Ic++}if(Rb<Xb-Dc&&Kc==true){Qb=Qb-jb;Rb=Rb-kb;Sb=Sb-lb}}else{while(Rb<Xb-Dc&&Ic<Jc){Qb=Qb-jb;Rb=Rb-kb;Sb=Sb-lb;Kc=true;Ic++}}}_b=true;justSteppedIn=true;this.moveInOut++;this.moveIn++;Cb=0;myEdgeDetect=this.edgeDetectMask;var zc=v&myEdgeDetect;var Ac=w&myEdgeDetect;var Bc=x&myEdgeDetect;if(zc!=currentBlockMaskXcomp||Ac!=currentBlockMaskYcomp||Bc!=currentBlockMaskZcomp||cd==true){}}else{this.getKnownBlock(this.currentModel,Hb,Gb,false,h);Vc=true}}else{Vc=true}}else{_b=false}pc=false;if(_b==false&&Vc==false){tc=false;t=t+u;if(this.framesDelay>500){alert("currentPixelWidth"+t+" loopBlock "+j+" currentPixelRate "+u)}if(this.framesDelay>500){console.log("Stepping myZX:"+Kb+" "+Lb+" "+Mb+" myXX:"+Nb+" "+Ob+" "+Pb)}if(Tb==true){var cc=Kb+mb;var dc=Lb+nb;var ec=Mb+ob}else{var cc=Kb;var dc=Lb;var ec=Mb}if(Ub==true){var fc=Nb+gb;var gc=Ob+hb;var hc=Pb+ib}else{var fc=Nb;var gc=Ob;var hc=Pb}if(Vb==true){var ic=Qb+jb;var jc=Rb+kb;var kc=Sb+lb}else{var ic=Qb;var jc=Rb;var kc=Sb}var lc=Math.abs(cc-Wb)+Math.abs(ec-Yb)+Math.abs(dc-Xb);var mc=Math.abs(fc-Wb)+Math.abs(hc-Yb)+Math.abs(gc-Xb);var nc=Math.abs(ic-Wb)+Math.abs(kc-Yb)+Math.abs(jc-Xb);var gd=false;if(this.framesDelay>500){console.log("Comparison with compare ZX"+cc+" "+dc+" "+ec+" YX"+ic+" "+jc+" "+kc+"XX:"+fc+" "+gc+" "+hc)}if(lc<mc){if(lc<nc){Kb=cc;Lb=dc;Mb=ec;Wb=Kb;Xb=Lb;Yb=Mb;x=x+ab;if(this.framesDelay>500){console.log("z =z + "+ab)}qc="z";Tb=true}else{Qb=ic;Rb=jc;Sb=kc;Wb=Qb;Xb=Rb;Yb=Sb;w=w+$;if(this.framesDelay>500){console.log("y =y + "+$)}qc="y";Vb=true}}else{if(mc<nc){Nb=fc;Ob=gc;Pb=hc;Wb=Nb;Xb=Ob;Yb=Pb;v=v+Y;qc="x";if(this.framesDelay>500){console.log("x =x + "+Y)}Ub=true}else{Qb=ic;Rb=jc;Sb=kc;Wb=Qb;Xb=Rb;Yb=Sb;w=w+$;qc="y";if(this.framesDelay>500){console.log("y =y + "+$)}Vb=true}}if(this.framesDelay>500){console.log("New px:"+Wb+" "+Xb+" "+Yb)}yb=yb+V;zb=zb+W;Ab=Ab+X}else{}this.depthAverage++;Zb+=U}if(this.framesDelay>500){console.log("End of line colour:"+Cb);this.framesDelay=0}if(this.twomap==true){}this.parent=null;this.modelList=null;B=null;C=null;D=null;E=null;F=null;G=null;H=null;I=null;J=null;K=null;L=null;M=null;N=null;O=null;P=null;Q=null;R=null;S=null;y=null;z=null;A=null;this.rayWentDist=Zb;this.rayWentX=Wb;this.rayWentY=Xb;this.rayWentZ=Yb;return Cb}function precalcRayDelta(a,b){if(a>=this.xPreCalc){var c=this.xPreCalc+1}else{var c=a+1}this.firstStepXDXDelta[a][b]=this.firstStepXDX[c][b]-this.firstStepXDX[a][b]>>this.PreCalcApproxShift;this.firstStepXDYDelta[a][b]=this.firstStepXDY[c][b]-this.firstStepXDY[a][b]>>this.PreCalcApproxShift;this.firstStepXDZDelta[a][b]=this.firstStepXDZ[c][b]-this.firstStepXDZ[a][b]>>this.PreCalcApproxShift;this.firstStepYDXDelta[a][b]=this.firstStepYDX[c][b]-this.firstStepYDX[a][b]>>this.PreCalcApproxShift;this.firstStepYDYDelta[a][b]=this.firstStepYDY[c][b]-this.firstStepYDY[a][b]>>this.PreCalcApproxShift;this.firstStepYDZDelta[a][b]=this.firstStepYDZ[c][b]-this.firstStepYDZ[a][b]>>this.PreCalcApproxShift;this.firstStepZDXDelta[a][b]=this.firstStepZDX[c][b]-this.firstStepZDX[a][b]>>this.PreCalcApproxShift;this.firstStepZDYDelta[a][b]=this.firstStepZDY[c][b]-this.firstStepZDY[a][b]>>this.PreCalcApproxShift;this.firstStepZDZDelta[a][b]=this.firstStepZDZ[c][b]-this.firstStepZDZ[a][b]>>this.PreCalcApproxShift;this.eachStepXDXDelta[a][b]=this.eachStepXDX[c][b]-this.eachStepXDX[a][b]>>this.PreCalcApproxShift;this.eachStepXDYDelta[a][b]=this.eachStepXDY[c][b]-this.eachStepXDY[a][b]>>this.PreCalcApproxShift;this.eachStepXDZDelta[a][b]=this.eachStepXDZ[c][b]-this.eachStepXDZ[a][b]>>this.PreCalcApproxShift;this.eachStepYDXDelta[a][b]=this.eachStepYDX[c][b]-this.eachStepYDX[a][b]>>this.PreCalcApproxShift;this.eachStepYDYDelta[a][b]=this.eachStepYDY[c][b]-this.eachStepYDY[a][b]>>this.PreCalcApproxShift;this.eachStepYDZDelta[a][b]=this.eachStepYDZ[c][b]-this.eachStepYDZ[a][b]>>this.PreCalcApproxShift;this.eachStepZDXDelta[a][b]=this.eachStepZDX[c][b]-this.eachStepZDX[a][b]>>this.PreCalcApproxShift;this.eachStepZDYDelta[a][b]=this.eachStepZDY[c][b]-this.eachStepZDY[a][b]>>this.PreCalcApproxShift;this.eachStepZDZDelta[a][b]=this.eachStepZDZ[c][b]-this.eachStepZDZ[a][b]>>this.PreCalcApproxShift}function stepRayCalcs(a,b){var c=a>>this.PreCalcApproxShift;if(c!=this.lastIsx){this.curFirstStepXDX=this.firstStepXDX[c][b];this.curFirstStepXDXDelta=this.firstStepXDXDelta[c][b];this.curFirstStepXDY=this.firstStepXDY[c][b];this.curFirstStepXDYDelta=this.firstStepXDYDelta[c][b];this.curFirstStepXDZ=this.firstStepXDZ[c][b];this.curFirstStepXDZDelta=this.firstStepXDZDelta[c][b];this.curFirstStepYDX=this.firstStepYDX[c][b];this.curFirstStepYDXDelta=this.firstStepYDXDelta[c][b];this.curFirstStepYDY=this.firstStepYDY[c][b];this.curFirstStepYDYDelta=this.firstStepYDYDelta[c][b];this.curFirstStepYDZ=this.firstStepYDZ[c][b];this.curFirstStepYDZDelta=this.firstStepYDZDelta[c][b];this.curFirstStepZDX=this.firstStepZDX[c][b];this.curFirstStepZDXDelta=this.firstStepZDXDelta[c][b];this.curFirstStepZDY=this.firstStepZDY[c][b];this.curFirstStepZDYDelta=this.firstStepZDYDelta[c][b];this.curFirstStepZDZ=this.firstStepZDZ[c][b];this.curFirstStepZDZDelta=this.firstStepZDZDelta[c][b];this.curEachStepXDX=this.eachStepXDX[c][b];this.curEachStepXDXDelta=this.eachStepXDXDelta[c][b];this.curEachStepXDY=this.eachStepXDY[c][b];this.curEachStepXDYDelta=this.eachStepXDYDelta[c][b];this.curEachStepXDZ=this.eachStepXDZ[c][b];this.curEachStepXDZDelta=this.eachStepXDZDelta[c][b];this.curEachStepYDX=this.eachStepYDX[c][b];this.curEachStepYDXDelta=this.eachStepYDXDelta[c][b];this.curEachStepYDY=this.eachStepYDY[c][b];this.curEachStepYDYDelta=this.eachStepYDYDelta[c][b];this.curEachStepYDZ=this.eachStepYDZ[c][b];this.curEachStepYDZDelta=this.eachStepYDZDelta[c][b];this.curEachStepZDX=this.eachStepZDX[c][b];this.curEachStepZDXDelta=this.eachStepZDXDelta[c][b];this.curEachStepZDY=this.eachStepZDY[c][b];this.curEachStepZDYDelta=this.eachStepZDYDelta[c][b];this.curEachStepZDZ=this.eachStepZDZ[c][b];this.curEachStepZDZDelta=this.eachStepZDZDelta[c][b]}else{this.curFirstStepXDX+=this.curFirstStepXDXDelta;this.curFirstStepXDY+=this.curFirstStepXDYDelta;this.curFirstStepXDZ+=this.curFirstStepXDZDelta;this.curFirstStepYDX+=this.curFirstStepYDXDelta;this.curFirstStepYDY+=this.curFirstStepYDYDelta;this.curFirstStepYDZ+=this.curFirstStepYDZDelta;this.curFirstStepZDX+=this.curFirstStepZDXDelta;this.curFirstStepZDY+=this.curFirstStepZDYDelta;this.curFirstStepZDZ+=this.curFirstStepZDZDelta;this.curEachStepXDX=this.curEachStepXDX+this.curEachStepXDXDelta;this.curEachStepXDY=this.curEachStepXDY+this.curEachStepXDYDelta;this.curEachStepXDZ=this.curEachStepXDZ+this.curEachStepXDZDelta;this.curEachStepYDX=this.curEachStepYDX+this.curEachStepYDXDelta;this.curEachStepYDY=this.curEachStepYDY+this.curEachStepYDYDelta;this.curEachStepYDZ=this.curEachStepYDZ+this.curEachStepYDZDelta;this.curEachStepZDX=this.curEachStepZDX+this.curEachStepZDXDelta;this.curEachStepZDY=this.curEachStepZDY+this.curEachStepZDYDelta;this.curEachStepZDZ=this.curEachStepZDZ+this.curEachStepZDZDelta}this.lastIsx=c}function plotScreenScaler(){var a=new Date;if(this.twomap==true){for(n=0;n<this.width*this.height*4;n+=4){u=255,v=255;w=255;this.imageData.data[n]=u;this.imageData.data[n+1]=v;this.imageData.data[n+2]=w;this.imageData.data[n+3]=255}}if(this.spinning==true&&this.rotateAroundX){this.spin(this.spinUpDown,this.spinLeftRight,0)}this.eyeX=this.moveToX;this.eyeY=this.moveToY;this.eyeZ=this.moveToZ;this.mouseInRotatePos(this.sx,this.sy);var b=this.rotate3D(this.pitch,this.yaw,this.roll,0,0,this.lookDist);this.lookX=b[0];this.lookY=b[1];this.lookZ=b[2];this.stayInWorldBounds();this.raysDirection();screenIndex=0;this.depthAverage=0;this.moveInOut=0;var c=this.lookX+this.width/2*-this.stepXacr+this.height/2*-this.stepXdown;var d=this.lookY+this.width/2*-this.stepYacr+this.height/2*-this.stepYdown;var e=this.lookZ+this.width/2*-this.stepZacr+this.height/2*-this.stepZdown;var f=this.stepXacr*this.PreCalcApprox;var g=this.stepYacr*this.PreCalcApprox;var h=this.stepZacr*this.PreCalcApprox;for(var i=0;i<this.height;i++){var j=c;var k=d;var l=e;for(var m=0;m<this.xPreCalc+2;m++){if(this.precalcRay(j,k,l,m,i)==false){}j+=f;k+=g;l+=h}c+=this.stepXdown;d+=this.stepYdown;e+=this.stepZdown}for(var i=0;i<this.height;i++){for(var m=0;m<this.xPreCalc+1;m++){this.precalcRayDelta(m,i)}}for(var n=0;n<10;n++){var o=Math.random()*this.width;var p=Math.random()*this.height;randSX=o-this.width/2;randSY=p-this.height/2;var j=this.lookX+randSX*-this.stepXacr+randSY*-this.stepXdown;var k=this.lookY+randSX*-this.stepYacr+randSY*-this.stepYdown;var l=this.lookZ+randSX*-this.stepZacr+randSY*-this.stepZdown;if(this.twomap==false){if(o<this.width&&p<this.height){var q=o>>this.PreCalcApproxShift<<this.PreCalcApproxShift;this.stepRayCalcs(q,Math.floor(p));if(this.dataLoaded==true){this.stepThrough(j,k,l,Math.floor(q),Math.floor(p),true)}}}}var c=this.lookX+this.width/2*-this.stepXacr+this.height/2*-this.stepXdown;var d=this.lookY+this.width/2*-this.stepYacr+this.height/2*-this.stepYdown;var e=this.lookZ+this.width/2*-this.stepZacr+this.height/2*-this.stepZdown;for(var i=0;i<this.height;i++){var j=c;var k=d;var l=e;if(i>=0&&i<this.yraysStart+this.yrays){this.lastIsx=-1;for(var m=0;m<this.width;m++){if(m>=0&&m<this.xraysStart+this.xrays){if(this.twomap==true){if(m>=this.xraysStart&&i>=this.yraysStart){if(this.framesDelay>500){console.log("sx:"+m+"sy:"+i)}var r=m%this.PreCalcApprox;var s=m>>this.PreCalcApproxShift<<this.PreCalcApproxShift;this.stepRayCalcs(s,i);for(n=0;n<r;n++){this.stepRayCalcs(s+n,i)}if(this.dataLoaded==true){var t=this.stepThrough(j,k,l,m,i,false)}}}else{this.stepRayCalcs(m,i);if(this.dataLoaded==true){var t=this.stepThrough(j,k,l,m,i,false)}}}if(m==this.xraysStart&&i==this.yraysStart){t=4292005314}if(this.mouseDown==true){if(this.zoomToSX==m&&this.zoomToSY==i){this.zoomDist=this.rayWentDist;if(t!=0){this.spinX=this.rayWentX;this.spinY=this.rayWentY;this.spinZ=this.rayWentZ}}}if(t==0){t=4292005314}var u=t&255;var v=(t&65280)>>8;var w=(t&16711680)>>16;if(this.twomap==false){this.imageData.data[screenIndex]=u;this.imageData.data[screenIndex+1]=v;this.imageData.data[screenIndex+2]=w;this.imageData.data[screenIndex+3]=255}screenIndex+=4;j+=this.stepXacr;k+=this.stepYacr;l+=this.stepZacr}}c+=this.stepXdown;d+=this.stepYdown;e+=this.stepZdown}this.depthFinalAverage=this.depthAverage/(this.width*this.height);this.moveInOutFinalAverage=this.moveInOut/(this.width*this.height);this.start++;this.bufferContext.putImageData(this.imageData,0,0);if(this.twoMap==true){this.bufferContext.fillText("Colour "+t,10,10);this.bufferContext.fillText("Eye X "+this.eyeX+" Y "+this.eyeY+" Z "+this.eyeZ,10,20);this.bufferContext.fillText("Look X "+this.lookX+" Y "+this.lookY+" Z "+this.lookZ,10,30);var y=2;var A=50;var B=50;var C=19;x=this.loopEdgeOrig*1;z=0;this.bufferContext.fillText(x,(x>>C)+A,(z>>C)+B);x=this.loopEdgeOrig*3;z=0;this.bufferContext.fillText(x,(x>>C)+A,(z>>C)+B);x=0;z=this.loopEdgeOrig*1;this.bufferContext.fillText(z,(x>>C)+A,(z>>C)+B);x=0;z=this.loopEdgeOrig*3;this.bufferContext.fillText(z,(x>>C)+A,(z>>C)+B)}if(this.viewTech==true){this.bufferContext.fillText("Yaw "+this.yaw,10,30);this.bufferContext.fillText("Look X "+Math.floor(this.lookX)+" Y "+Math.floor(this.lookY)+" Z "+Math.floor(this.lookZ),10,20);this.bufferContext.fillText("EX "+Math.floor(this.eyeX)+" Y "+Math.floor(this.eyeY)+" Z "+Math.floor(this.eyeZ),10,10)}this.outputContext.drawImage(this.buffer,0,0,this.outputWidth,this.outputHeight);this.framesDelay+=this.framesDelayDiff;this.rotating=false;var D=new Date;this.frameTime=D-a;this.maxSpinSpeed=.12/((this.frameTime+1e-4)/1e3);that=this;if(this.realityHasFocus==true){setTimeout(function(){that.plotScreenScaler()},40)}return}function stayInWorldBounds(){if(this.eyeZ>this.loopScaleOrigMask){this.eyeZ=this.loopScaleOrigMask}if(this.eyeZ<0){this.eyeZ=0}if(this.eyeX>this.loopScaleOrigMask){this.eyeX=this.loopScaleOrigMask}if(this.eyeX<0){this.eyeX=0}if(this.eyeY>this.loopScaleOrigMask){this.eyeY=this.loopScaleOrigMask}if(this.eyeY<0){this.eyeY=0}}function stayInWorldBoundsGeneric(a,b,c){var d=false;if(c>this.loopScaleOrigMask){c=this.loopScaleOrigMask;d=true}if(c<0){c=0;d=true}if(a>this.loopScaleOrigMask){a=this.loopScaleOrigMask;d=true}if(a<0){a=0;d=true}if(b>this.loopScaleOrigMask){b=this.loopScaleOrigMask;d=true}if(b<0){b=0;d=true}var e=[];e[0]=a;e[1]=b;e[2]=c;e[3]=d;return e}function processKeypress(a,b){var b=a.keyCode;var c=String.fromCharCode(b);if(b=="37"){c="a";a.preventDefault()}if(b=="39"){c="d";a.preventDefault()}if(b=="38"){c="w";a.preventDefault()}if(b=="40"){c="s";a.preventDefault()}if(b=="33"){c="1";a.preventDefault()}if(b=="34"){c="2";a.preventDefault()}this.processKeyPressInCanvas(a,c)}function processKeyPressInCanvas(a,b){if(!b){var c=a.keyCode;var b=String.fromCharCode(c)}var d=15*256*16*(this.frameTime/1e3);var e=.02;var f=this.maxSpinSpeed;if(this.twomap==true){e=5e-4}switch(b){case"w":if(this.spinning==true){this.spinUpDown=f;this.spinLeftRight=0}else{this.moveToZ=this.eyeZ+this.lookZ*d;this.moveToX=this.eyeX+this.lookX*d}break;case"s":if(this.spinning==true){this.spinUpDown=-f;this.spinLeftRight=0}else{this.moveToZ=this.eyeZ-this.lookZ*d;this.moveToX=this.eyeX-this.lookX*d}break;case"a":if(this.spinning==true){this.spinLeftRight=-f;this.spinUpDown=0}else{this.yaw+=e}break;case"d":if(this.spinning==true){this.spinLeftRight=f;this.spinUpDown=0}else{this.yaw+=-e}break;case"1":if(this.pitch>-(Math.PI/2)){this.pitch-=e}else{this.pitch=-Math.PI/2}break;case"2":if(this.pitch<Math.PI/2){this.pitch+=e}else{this.pitch=Math.PI/2}break;case"6":alert("Look Z:"+this.lookZ+" Look Y:"+this.lookY+" LookX:"+this.lookX+"Rotating:"+this.rotating);break;case"R":this.moveToY=this.eyeY+=5e3*256*16;break;case"F":this.moveToY=this.eyeY-5e3*256*16;break;case"p":this.pause();break;case"t":this.debug=true;break;case"0":this.framesDelay=6e3;break;case"i":this.raySpeedConst+=5;break;case"u":this.raySpeedConst-=5;break;case"V":console.log("Eye X:"+this.eyeX+" Eye Z"+this.eyeZ+" Look X"+this.lookX+" Look Z"+this.lookZ+" Average depth: "+this.depthFinalAverage+" Moving in/out of scale average: "+this.moveInOutFinalAverage+" Ray speed const:"+this.raySpeedConst+" this.stepXacr"+this.stepXacr+" this.stepYacr"+this.stepYacr+" this.stepZacr"+this.stepZacr+" Move in total="+this.moveIn+" Move out total="+this.moveOut);this.viewTech=true;break;case"b":console.log("this.firstStepYDX"+this.firstStepYDX+"this.firstStepYDY"+this.firstStepYDY+"this.firstStepYDZ"+this.firstStepYDZ+"this.eachStepYDX"+this.eachStepYDX+"this.eachStepYDY"+this.eachStepYDY+"this.eachStepYDZ"+this.eachStepYDZ);break;case"m":if(this.showMap==false){this.showMap=true;this.twomap=true;this.yrays=1;this.xrays=1}else{this.showMap=false;this.twomap=false;this.yraysStart=0;this.xraysStart=0;this.yrays=200;this.xrays=300}break;case"g":this.colourWrong=true;break}}function cancelEvent(a){if(!a)a=window.event;if(a.preventDefault){a.preventDefault()}else{a.returnValue=false}}function prepareScreen(a){if(!a.eyeX){}else{this.eyeX=a.eyeX;this.eyeY=a.eyeY;this.eyeZ=a.eyeZ;this.moveToX=this.eyeX;this.moveToY=this.eyeY;this.moveToZ=this.eyeZ}if(!a.yaw){}else{this.yaw=a.yaw;this.pitch=a.pitch;this.roll=a.roll}if(!a.parentServer){this.parentServer="http://127.0.0.1:10000"}else{this.parentServer=a.parentServer}if(!a.parentDatabase){this.parentDatabase="voxel_parent"}else{this.parentDatabase=a.parentDatabase}this.socket=[];this.newModel=[];this.newModel[1]=true;this.clientRequestId=1;this.uniqueModelDbPerServer=[];this.uniqueModelDbPerServer[1]=[];this.uniqueModelDbPerServer[1][this.parentDatabase]=true;this.uniqueServer=[];this.uniqueServer[this.parentServer]=1;this.dbSocketCnt=1;this.socketCnt=1;this.modelSocket=[];this.modelDb=[];if(!a.outputWidth){this.outputWidth=600;this.outputHeight=400;this.width=300;this.height=200;this.yrays=200;this.xrays=300}else{this.outputWidth=a.outputWidth;this.outputHeight=a.outputHeight;this.width=a.raysWidth;this.height=a.raysHeight;this.xrays=a.raysWidth;this.yrays=a.raysHeight}this.xRatio=this.outputWidth/this.width;this.yRatio=this.outputHeight/this.height;this.xPreCalc=Math.floor(this.xrays/this.PreCalcApprox);this.yPreCalc=this.yrays;this.maxDepth=120;if(a.canvas){var b=a.canvas}else{var b="reality"}var c=document.getElementById(b);this.canvas=c;var d=this;c.addEventListener("mousedown",function(b){return d.ev_mousedown(b)},false);c.addEventListener("mouseup",function(b){return d.ev_mouseup(b)},false);c.addEventListener("mousemove",function(b){return d.processMouseover(b,d)},false);c.addEventListener("mouseout",function(b){return d.ev_mouseout(b)},false);c.addEventListener("dragstart",function(a){cancelEvent(a)});c.addEventListener("selectstart",function(a){cancelEvent(a)});c.addEventListener("touchstart",function(b){return d.ev_touchstart(b)},false);c.addEventListener("touchmove",function(b){return d.ev_touchmove(b)},false);c.addEventListener("touchend",function(b){return d.ev_touchend(b)},false);c.addEventListener("onkeydown",function(b){return d.processKeypressInCanvas(b)});document.onkeydown=function(b){return d.processKeypress(b)};this.outputContext=c.getContext("2d");var e=document.createElement("canvas");e.width=this.width;e.height=this.height;this.bufferContext=e.getContext("2d");this.buffer=e;this.imageData=this.bufferContext.createImageData(this.width,this.height);this.lastSX=this.width/2;this.lastSY=this.height/2;this.lastFrameSX=this.lastSX;this.lastFrameSY=this.lastSY;this.lastControlsSX=this.lastSX;this.lastControlsSY=this.lastSY;this.blockRegistered[2]=[];this.determineCursorType("zoom");this.raysDirection();this.pixelWidth=Math.floor(Math.abs(this.stepXacr+this.stepZacr+this.stepYacr)/3*this.raySpeedConst);this.pixelRate=Math.floor(2097151*this.width/200);for(var f=0;f<=this.xPreCalc+1;f++){this.firstStepXDX[f]=new Array(this.yPreCalc);this.firstStepXDY[f]=new Array(this.yPreCalc);this.firstStepXDZ[f]=new Array(this.yPreCalc);this.firstStepYDX[f]=new Array(this.yPreCalc);this.firstStepYDY[f]=new Array(this.yPreCalc);this.firstStepYDZ[f]=new Array(this.yPreCalc);this.firstStepZDX[f]=new Array(this.yPreCalc);this.firstStepZDY[f]=new Array(this.yPreCalc);this.firstStepZDZ[f]=new Array(this.yPreCalc);this.eachStepXDX[f]=new Array(this.yPreCalc);this.eachStepXDY[f]=new Array(this.yPreCalc);this.eachStepXDZ[f]=new Array(this.yPreCalc);this.eachStepYDX[f]=new Array(this.yPreCalc);this.eachStepYDY[f]=new Array(this.yPreCalc);this.eachStepYDZ[f]=new Array(this.yPreCalc);this.eachStepZDX[f]=new Array(this.yPreCalc);this.eachStepZDY[f]=new Array(this.yPreCalc);this.eachStepZDZ[f]=new Array(this.yPreCalc);this.firstStepXDXDelta[f]=new Array(this.yPreCalc);this.firstStepXDYDelta[f]=new Array(this.yPreCalc);this.firstStepXDZDelta[f]=new Array(this.yPreCalc);this.firstStepYDXDelta[f]=new Array(this.yPreCalc);this.firstStepYDYDelta[f]=new Array(this.yPreCalc);this.firstStepYDZDelta[f]=new Array(this.yPreCalc);this.firstStepZDXDelta[f]=new Array(this.yPreCalc);this.firstStepZDYDelta[f]=new Array(this.yPreCalc);this.firstStepZDZDelta[f]=new Array(this.yPreCalc);this.eachStepXDXDelta[f]=new Array(this.yPreCalc);this.eachStepXDYDelta[f]=new Array(this.yPreCalc);this.eachStepXDZDelta[f]=new Array(this.yPreCalc);this.eachStepYDXDelta[f]=new Array(this.yPreCalc);this.eachStepYDYDelta[f]=new Array(this.yPreCalc);this.eachStepYDZDelta[f]=new Array(this.yPreCalc);this.eachStepZDXDelta[f]=new Array(this.yPreCalc);this.eachStepZDYDelta[f]=new Array(this.yPreCalc);this.eachStepZDZDelta[f]=new Array(this.yPreCalc)}}function pause(a){clearTimeout(this.pauseMe)}function getScreenXY(a){var b,c;var d=0;var e=0;var f=a.target;do{d+=f.offsetLeft;e+=f.offsetTop}while(f=f.offsetParent);var b;var c;if(a.pageX||a.pageY){b=a.pageX;c=a.pageY}else{var g=document.documentElement?document.documentElement.scrollTop:document.body.scrollTop;b=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;c=a.clientY+document.body.scrollTop+g}b-=d;c-=e;var h=[b,c];return h}function mouseInRotatePos(a,b){var c=.2*(this.frameTime/1e3);var d=4;var e=5;var f=4;var g=this.lastFrameSX;var h=this.lastFrameSY;if(this.mouseOut==false){if(this.mouseDown==true){if(Math.abs(g-a)>f){this.spinning=true;this.moveToX=this.eyeX;this.moveToY=this.eyeY;this.moveToZ=this.eyeZ}if(Math.abs(h-b)>f){this.spinning=true;this.moveToX=this.eyeX;this.moveToY=this.eyeY;this.moveToZ=this.eyeZ}}if(this.spinning==false){if(a<this.outputWidth/e){this.yaw+=c;this.rotating=true}if(a>this.outputWidth-this.outputWidth/e){this.yaw+=-c;this.rotating=true}if(b>this.outputHeight-this.outputHeight/e){if(this.pitch<Math.PI/2){this.pitch+=c}else{this.pitch=Math.PI/2}this.rotating=true}if(b<this.outputHeight/e){if(this.pitch>-(Math.PI/2)){this.pitch-=c}else{this.pitch=-Math.PI/2}this.rotating=true}}else{this.spinLeftRight=0;this.spinUpDown=0;var i=g-a;var j=h-b;if(Math.abs(i)>Math.abs(j)){if(g-a>0){this.spinLeftRight=this.maxSpinSpeed;this.spinUpDown=0}if(g-a<0){this.spinLeftRight=-this.maxSpinSpeed;this.spinUpDown=0}}else{if(h-b<0){this.spinLeftRight=0;this.spinUpDown=this.maxSpinSpeed}if(h-b>0){this.spinLeftRight=0;this.spinUpDown=-this.maxSpinSpeed}}}}this.lastFrameSX=a;this.lastFrameSY=b}function ev_mouseout(a){this.mouseOut=true;this.mouseDown=false;this.spinning=false;this.spinUpDown=0;this.spinLeftRight=0;this.rotateAroundFixed=false}function processMouseover(a){this.mouseOut=false;var b=5;coords=this.getScreenXY(a);this.sx=coords[0];this.sy=coords[1];var c=false;if(this.spinning==true){this.determineCursorType("move")}else{if(this.sx<this.outputWidth/b){if(this.cursor!="w-resize"){this.determineCursorType("w-resize")}c=true}if(this.sx>this.outputWidth-this.outputWidth/b){if(this.cursor!="e-resize"){this.determineCursorType("e-resize")}c=true}if(this.sy>this.outputHeight-this.outputHeight/b){if(this.cursor!="s-resize"){this.determineCursorType("s-resize")}c=true}if(this.sy<this.outputHeight/b){if(this.cursor!="n-resize"){this.determineCursorType("n-resize")}c=true}if(this.cursor!="zoom"&&c==false){this.determineCursorType("zoom")}}}function ev_mouseclick(a){coords=this.getScreenXY(a);var b=coords[0];var c=coords[1]}function repositionTouch(a){var b;var c;if(a.targetTouches.length==1){var d=a.targetTouches[0];b=d.pageX;c=d.pageY;var e=b-this.touchLastX;var f=c-this.touchLastY;this.touchLastX=b;this.touchLastY=c;if(e<0){this.yaw+=rotate;this.rotating=true}if(e>0){this.yaw+=-rotate;this.rotating=true}if(f<0){if(this.pitch<Math.PI/2){this.pitch+=rotate}else{this.pitch=Math.PI/2}this.rotating=true}if(f>0){if(this.pitch>-(Math.PI/2)){this.pitch-=rotate}else{this.pitch=-Math.PI/2}this.rotating=true}a.preventDefault();return false}if(a.targetTouches.length==2){b=(a.targetTouches[0].pageX+a.targetTouches[1].pageX)/2;c=(a.targetTouches[0].pageY+a.targetTouches[1].pageY)/2;var e=b-this.touchLastX;var f=c-this.touchLastY;this.touchLastX=b;this.touchLastY=c;dist=Math.abs(a.targetTouches[0].pageX-a.targetTouches[1].pageX)+Math.abs(a.targetTouches[0].pageY-a.targetTouches[1].pageY);a.preventDefault();return false}}function ev_touchstart(a){this.touch=true;if(a.targetTouches.length==1){var b=a.targetTouches[0];this.touchLastX=b.pageX;this.touchLastY=b.pageY}if(a.targetTouches.length==2){this.touchLastX=(a.targetTouches[0].pageX+a.targetTouches[1].pageX)/2;this.touchLastY=(a.targetTouches[0].pageY+a.targetTouches[1].pageY)/2}this.repositionTouch(a)}function ev_touchmove(a){this.repositionTouch(a)}function ev_touchend(a){}function determineCursorType(a){this.cursor=a;if(a!="zoom"){if(jQuery.browser.mozilla){this.canvas.style.cursor=a}else if(jQuery.browser.safari){this.canvas.style.cursor=a}else{this.canvas.style.cursor=a}}else{if(jQuery.browser.mozilla){this.canvas.style.cursor="-moz-zoom-in"}else if(jQuery.browser.safari){this.canvas.style.cursor="-webkit-zoom-in"}else{this.canvas.style.cursor="url('http://rvolve.com/images/magnify_plus.cur')"}}}function ev_mousedown(a){coords=this.getScreenXY(a);this.zoomToSX=Math.floor(coords[0]/this.xRatio);this.zoomToSY=Math.floor(coords[1]/this.yRatio);try{this.lastSX=coords[0];this.lastSY=coords[1];this.sx=coords[0];this.sy=coords[1];this.lastControlsSX=this.sx;this.lastControlsSY=this.sy;this.lastFrameSX=this.sx;this.lastFrameSY=this.sy;var b=this.zoomToSX;var c=this.zoomToSY;randSX=-(b-this.width/2);randSY=-(c-this.height/2);this.zoomX=this.lookX+randSX*-this.stepXacr+randSY*-this.stepXdown;this.zoomY=this.lookY+randSX*-this.stepYacr+randSY*-this.stepYdown;this.zoomZ=this.lookZ+randSX*-this.stepZacr+randSY*-this.stepZdown;this.mouseDown=true}catch(a){}return false}function ev_mouseup(a){try{this.mouseDown=false;this.spinning=false;this.spinUpDown=0;this.spinLeftRight=0;this.rotateAroundFixed=false}catch(a){}}function respondToControls(){var a=this.sx;var b=this.sy;var c=4;if(this.mouseDown==true){lastSx=this.lastControlsSX;lastSy=this.lastControlsSY;if(Math.abs(lastSx-a)>c){this.spinning=true}if(Math.abs(lastSy-b)>c){this.spinning=true}}this.lastControlsSX=a;this.lastControlsSY=b;if(this.zoomDist>this.raySpeedConst/300){this.zoomDistFromSolid=this.zoomDist/100;var d=15*256*(this.frameTime/1e3);if(this.mouseDown==true&&this.zoomX&&this.spinning==false){this.moveToX=this.eyeX+d*this.zoomDistFromSolid*this.zoomX;this.moveToY=this.eyeY+d*this.zoomDistFromSolid*this.zoomY;this.moveToZ=this.eyeZ+d*this.zoomDistFromSolid*this.zoomZ}}if(this.mouseDown==true&&this.spinning==true){if(this.rotateAroundFixed==false){if(this.spinX){this.rotateAroundFixed=true;this.rotateAroundX=this.spinX;this.rotateAroundY=this.spinY;this.rotateAroundZ=this.spinZ}else{this.spinning=false}}}}function spin(a,b,c){var d,e,f;d=this.eyeX-this.rotateAroundX;e=this.eyeY-this.rotateAroundY;f=this.eyeZ-this.rotateAroundZ;if(a!=0){var g=-Math.atan2(d,f);var h=this.rotate3D(0,g,c,d,e,f);var h=this.rotate3D(-a,b,c,h[0],h[1],h[2]);var h=this.rotate3D(0,-g,c,h[0],h[1],h[2])}else{var h=this.rotate3D(a,b,c,d,e,f)}d=h[0];e=h[1];f=h[2];var i=d+this.rotateAroundX;var j=e+this.rotateAroundY;var k=f+this.rotateAroundZ;var l=this.stayInWorldBoundsGeneric(i,j,k);i=l[0];j=l[1];k=l[2];d=i-this.rotateAroundX;e=j-this.rotateAroundY;f=k-this.rotateAroundZ;if(d>0){var m=Math.atan2(-d,-f)}else{var m=-Math.PI+Math.atan2(d,f)}if(f<=0){var n=-Math.atan2(-e*Math.cos(m),-f)}else{var n=Math.atan2(-e*Math.cos(m),f)}var o=.05;var p=true;if(n>=Math.PI/2-o){n=Math.PI/2-o;p=false}if(n<=-Math.PI/2+o){n=-Math.PI/2+o;p=false}if(m>0){m=m-2*Math.PI}if(m<-(2*Math.PI)){m=m+2*Math.PI}var q=this.maxSpinSpeed;if(Math.abs(this.yaw-m)>Math.PI){this.yaw=m}else{if(m>this.yaw){this.yaw+=q;if(this.yaw>m){this.yaw=m}}else{this.yaw-=q;if(this.yaw<m){this.yaw=m}}}if(n>this.pitch){this.pitch+=q;if(this.pitch>n){this.pitch=n}}else{this.pitch-=q;if(this.pitch<n){this.pitch=n}}if(p==true){this.moveToX=i;this.moveToY=j;this.moveToZ=k}this.roll=0}function startRendering(){var a=this;this.respondControlsTimer=setInterval(function(){a.respondToControls()},100);this.pauseMe=setTimeout(function(){a.plotScreenScaler()},40)}function mainLoop(){if(typeof io==="undefined"){this.serverConnected=false;this.bufferContext.fillText("Sorry, no connection to",10,10);this.bufferContext.fillText(this.parentServer,10,20);this.outputContext.drawImage(this.buffer,0,0,this.outputWidth,this.outputHeight);return}else{this.socket[1]=io.connect(this.parentServer);var a=this;this.socket[1].on("connect",function(){a.serverConnected=true;startedReality=true;a.startRendering();return});this.socket[1].on("connect_failed",function(){a.serverConnected=false;a.bufferContext.fillText("Sorry, no connection to",10,10);a.bufferContext.fillText(a.parentServer,10,20);a.outputContext.drawImage(a.buffer,0,0,a.outputWidth,a.outputHeight);return})}return}this.mainLoop=mainLoop;this.prepareScreen=prepareScreen;this.pause=pause;this.raysDirection=raysDirection;this.ev_mouseclick=ev_mouseclick;this.ev_mousedown=ev_mousedown;this.ev_mouseup=ev_mouseup;this.ev_mouseout=ev_mouseout;this.cancelEvent=cancelEvent;this.getScreenXY=getScreenXY;this.onBlur=onRealityBlur;this.onFocus=onRealityFocus;this.respondToControls=respondToControls;this.processKeypress=processKeypress;this.processKeyPressInCanvas=processKeyPressInCanvas;this.processMouseover=processMouseover;this.start=0;this.precalcRay=precalcRay;this.precalcRayDelta=precalcRayDelta;this.rotate3D=rotate3D;this.determineCursorType=determineCursorType;this.eyeX=495938928;this.eyeY=8192e4;this.eyeZ=415036496;this.lookX=0;this.lookY=0;this.lookZ=-300;this.lookDist=300;this.yaw=Math.PI;this.pitch=0;this.roll=0;this.voxelBasic=[];this.stepXacr=0;this.stepYacr=0;this.stepZacr=0;this.stepXdown=0;this.stepYdown=0;this.stepZdown=0;this.blockCounter=0;this.maxScale=32;this.stepThrough=stepThrough;this.plotScreenScaler=plotScreenScaler;this.dataLoaded=false;this.dataLoading=false;this.scaleMask=520093696;this.outputShift=32;this.myBlocks=[];this.loopScaleOrigMask=805306368;this.loopStepOrig=268435456;this.edgeDetectMaskOrig=1073741824;this.loopBlockOrig=1879048192;this.addAfterShiftRight=1610612736;this.subAfterShiftLeft=1879048192;this.loopDetailOrig=268435455;this.loopEdgeOrig=268435456;this.invLoopBlockOrig=1073741823;this.xShiftOrig=28;this.yShiftOrig=26;this.zShiftOrig=24;this.maxScales=24;this.getKnownBlock=getKnownBlock;this.loopScale=this.maxScale;this.loopScaleMask=this.loopScaleOrigMask;this.edgeDetectMask=~this.loopScaleMask;this.chunkSize=4;this.scaleShift=2;this.xShift=28;this.yShift=26;this.zShift=24;this.currentBlock=0;this.parent=[];this.colours=1;this.childIndex=2;this.modelIndex=3;this.loadingCounter=0;this.priorityLoadingCounter=0;this.blockRegistered=[];this.debug=false;this.depthFinalAverage;this.depthAverage;this.moveInOut;this.moveOut=0;this.moveIn=0;this.moveInOutFinalAverage;this.raySpeedConst=130*16;this.rotate=rotate;this.stayInWorldBounds=stayInWorldBounds;this.framesDelay=0;this.framesDelayDiff=0;this.colourWrong=false;this.showMap=false;if(this.showMap==true){this.twomap=true;this.yraysStart=0;this.xraysStart=0;this.yrays=1;this.xrays=1}else{this.twomap=false;this.yraysStart=0;this.xraysStart=0;this.yrays=200;this.xrays=300}this.wrapWorld=false;this.PreCalcApprox=8;this.PreCalcApproxShift=3;this.lastIsx=-1;this.stepRayCalcs=stepRayCalcs;this.firstStepXDX=[];this.firstStepXDY=[];this.firstStepXDZ=[];this.firstStepYDX=[];this.firstStepYDY=[];this.firstStepYDZ=[];this.firstStepZDX=[];this.firstStepZDY=[];this.firstStepZDZ=[];this.eachStepXDX=[];this.eachStepXDY=[];this.eachStepXDZ=[];this.eachStepYDX=[];this.eachStepYDY=[];this.eachStepYDZ=[];this.eachStepZDX=[];this.eachStepZDY=[];this.eachStepZDZ=[];this.firstStepXDXDelta=[];this.firstStepXDYDelta=[];this.firstStepXDZDelta=[];this.firstStepYDXDelta=[];this.firstStepYDYDelta=[];this.firstStepYDZDelta=[];this.firstStepZDXDelta=[];this.firstStepZDYDelta=[];this.firstStepZDZDelta=[];this.eachStepXDXDelta=[];this.eachStepXDYDelta=[];this.eachStepXDZDelta=[];this.eachStepYDXDelta=[];this.eachStepYDYDelta=[];this.eachStepYDZDelta=[];this.eachStepZDXDelta=[];this.eachStepZDYDelta=[];this.eachStepZDZDelta=[];this.curEachStepXDX=0;this.curEachStepXDXDelta=0;this.curEachStepXDY=0;this.curEachStepXDYDelta=0;this.curEachStepXDZ=0;this.curEachStepXDZDelta=0;this.curEachStepYDX=0;this.curEachStepYDXDelta=0;this.curEachStepYDY=0;this.curEachStepYDYDelta=0;this.curEachStepYDZ=0;this.curEachStepYDZDelta=0;this.curEachStepZDX=0;this.curEachStepZDXDelta=0;this.curEachStepZDY=0;this.curEachStepZDYDelta=0;this.curEachStepZDZ=0;this.curFirstStepZDZDelta=0;this.modelCounter=1;this.currentModel=1;this.magicModel=this.currentModel;this.indInChunk=this.chunkSize*this.chunkSize*this.chunkSize;this.nullIndex=-1;this.newModelConst=-2;this.modelList=[];this.myBlocks[this.currentModel]=[];this.magicBlock=1;this.blockRegisteredURL=[];this.blockRegisteredURL[this.currentModel]=[];this.blockRegistered[this.currentModel]=[];this.modelURL=[];this.firstBlock=1;this.mouseDown=false;this.zoomToSX=-1;this.zoomToSY=-1;this.zoomX=0;this.zoomY=0;this.zoomZ=0;this.rayWentDist=0;this.zoomDist=0;this.moveToX=this.eyeX;this.moveToY=this.eyeY;this.moveToZ=this.eyeZ;this.mouseInRotatePos=mouseInRotatePos;this.cursor="zoom";this.determineCursorType=determineCursorType;this.pixelWidth=0;this.pixelRate=0;this.waitingOnChunk=[];this.frameTime=1e3;this.realityHasFocus=true;this.spin=spin;this.spinYaw=.2;this.spinning=false;this.rotateAroundFixed=false;this.spinUpDown=0;this.spinLeftRight=0;this.stayInWorldBoundsGeneric=stayInWorldBoundsGeneric;this.viewTech=false;this.serverConnected=false;this.startRendering=startRendering;this.myMaxDepth=this.raySpeedConst*20*16;this.ev_touchstart=ev_touchstart;this.ev_touchmove=ev_touchmove;this.ev_touchend=ev_touchend;this.repositionTouch=repositionTouch;if(!window.console)console={};console.log=console.log||function(){};console.warn=console.warn||function(){};console.error=console.error||function(){};console.info=console.info||function(){}};var startedReality=false;if(false){document.onfocusin=onRealityFocus;document.onfocusout=onRealityBlur}else{window.onfocus=onRealityFocus;window.onblur=onRealityBlur}

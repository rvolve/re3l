function onRealityBlur(){var e=reality;e.realityHasFocus=false;clearInterval(e.respondControlsTimer);clearTimeout(e.pauseMe);e.mouseDown=false;e.spinning=false;e.spinUpDown=0;e.spinLeftRight=0;e.rotateAroundFixed=false}function onRealityFocus(){var e=reality;if(startedReality==true){if(e.realityHasFocus==false){e.realityHasFocus=true;e.startRendering()}}}var reality=new function(){function rotate(e,t,n){var r=n;var i=e;var s=t;var o=i*Math.cos(r)-s*Math.sin(r);var u=s*Math.cos(r)+i*Math.sin(r);var a=new Array(2);a[0]=o;a[1]=u;return a}function rotate3D(e,t,n,r,i,s){var o=Math.cos(e);var u=Math.cos(t);var a=Math.cos(n);var f=Math.sin(e);var l=Math.sin(t);var c=Math.sin(n);var h=u*a;var p=f*l*a-o*c;var d=o*l*a+f*c;var v=u*c;var m=o*a+f*l*c;var g=-f*a+o*l*c;var y=-l;var b=f*u;var w=o*u;var E=new Array(3);E[0]=r*h+i*p+s*d;E[1]=r*v+i*m+s*g;E[2]=r*y+i*b+s*w;return E}function raysDirection(){var e=Math.sqrt(this.lookX*this.lookX+this.lookY*this.lookY+this.lookZ*this.lookZ);var t=1.25;var n=this.rotate3D(this.pitch,this.yaw,this.roll,-t,0,0);this.stepXacr=n[0];this.stepYacr=n[1];this.stepZacr=n[2];this.stepXdown=(this.lookY*this.stepZacr-this.lookZ*this.stepYacr)*t/e;this.stepYdown=(this.lookZ*this.stepXacr-this.lookX*this.stepZacr)*t/e;this.stepZdown=(this.lookX*this.stepYacr-this.lookY*this.stepXacr)*t/e;this.stepXacr*=this.screenSizeRatio;this.stepYacr*=this.screenSizeRatio;this.stepZacr*=this.screenSizeRatio;this.stepXdown*=this.screenSizeRatio;this.stepYdown*=this.screenSizeRatio;this.stepZdown*=this.screenSizeRatio;return}function getKnownBlock(modelId,chunkId,index,pauseTillLoaded,priority){if(this.loadingCounter<200||priority==true&&this.priorityLoadingCounter<40){var parentModelId=modelId;var socket=1;var dbname=this.parentDatabase;var newModel=false;if(isNaN(chunkId)){var url=chunkId;if(!this.blockRegisteredURL[modelId]){this.blockRegisteredURL[modelId]=[]}if(!this.blockRegisteredURL[modelId][url]||this.blockRegisteredURL[modelId][url]==false){if(!this.blockRegisteredURL[modelId]){this.blockRegisteredURL[modelId]=[]}this.blockRegisteredURL[modelId][url]=true;this.modelCounter++;modelId=this.modelCounter;var connectTo=url.split("?");if(!this.uniqueServer[connectTo[0]]){this.socketCnt++;this.uniqueServer[connectTo[0]]=this.socketCnt;this.socket[this.socketCnt]=this.io.connect(connectTo[0],{"connect timeout":1e4});var connectTo0=connectTo[0];var socketCnt=this.socketCnt;var that=this;this.socket[this.socketCnt].on("disconnect",function(){that.socket[socketCnt]=io.connect(connectTo0,{"connect timeout":1e4});var e=that;var t=socketCnt;that.socket[socketCnt].on("connect",function(){e.loadingCounter=0;for(block in e.blockRegistered){for(chunk in e.blockRegistered[block]){block=parseInt(block);chunk=parseInt(chunk);if(e.blockRegistered[block][chunk]==true){e.blockRegistered[block][chunk]=null}}}e.reconnectedSocket[t]=true})});var socket=this.socketCnt;var dbname=connectTo[1].split("=")[1];this.uniqueModelDbPerServer[socket]=[];this.uniqueModelDbPerServer[socket][dbname]=true}else{var socket=this.uniqueServer[connectTo[0]];var dbname=connectTo[1].split("=")[1];if(!this.uniqueModelDbPerServer[socket][dbname]){this.uniqueModelDbPerServer[socket][dbname]=true;this.dbSocketCnt++;var dbSocketId=this.dbSocketCnt}else{}}this.modelSocket[modelId]=socket;this.modelDb[modelId]=dbname;newModel=true;this.blockRegistered[modelId]=[];this.myBlocks[modelId]=[];var chunkId=1}else{this.dataLoading=true;return}}var parentBlock=this.currentBlock;if(!this.blockRegistered[modelId][chunkId]){this.blockRegistered[modelId][chunkId]=true;var serverAjax=false;if(serverAjax==true){var strServe="http://127.0.0.1/rvolve/project/voxel/reality_serve.php?db=voxel_parent&chunk_id="+chunkId+"&model_id="+modelId;if(this.modelURL[modelId]){strServe=this.modelURL[modelId]+"="+chunkId}else{}var that=this;$.get(strServe,function(response){var block=eval(response);that.myBlocks[modelId][block[0]]=block;that.myBlocks[modelId][block[0]][that.modelIndex]=[];for(var cnt=0;cnt<that.indInChunk;cnt++){that.myBlocks[modelId][block[0]][that.modelIndex][cnt]=0}that.myBlocks[modelId][block[0]].modelId=modelId;if(url){that.myBlocks[parentModelId][parentBlock][that.modelIndex][index]=modelId;that.myBlocks[parentModelId][parentBlock][that.childIndex][index]=that.newModelConst;that.blockRegisteredURL[parentModelId][url]=false}that.blockCounter++;if(priority==true){that.priorityLoadingCounter--}that.loadingCounter--;that.dataLoaded=true;that.dataLoading=false;if(pauseTillLoaded==true){that.currentBlock=block[0]}})}else{var newConnection=false;if(this.modelSocket[modelId]){socket=this.modelSocket[modelId];dbname=this.modelDb[modelId];if(this.reconnectedSocket[socket]){if(this.reconnectedSocket[socket]==true){newConnection=true;this.reconnectedSocket[socket]=false}}}if(this.uniqueModelDbPerServer[socket][dbname]){if(this.uniqueModelDbPerServer[socket][dbname]==true){newConnection=true;this.uniqueModelDbPerServer[socket][dbname]=false}}var that=this;var db=dbname;var myPriority=priority;var myurl=url;var myModelId=modelId;var myParentBlock=parentBlock;this.clientRequestId++;this.loadingCounter++;if(priority==true){this.priorityLoadingCounter++}this.dataLoading=true;this.waitingOnChunk[this.clientRequestId]=true;this.socket[socket].on("chunk_request_reply"+this.clientRequestId,function(data){var block=eval(data);if(that.waitingOnChunk[block[3]]==true){that.waitingOnChunk[block[3]]=false;that.myBlocks[myModelId][block[0]]=block;that.myBlocks[myModelId][block[0]][that.modelIndex]=[];for(var cnt=0;cnt<that.indInChunk;cnt++){that.myBlocks[myModelId][block[0]][that.modelIndex][cnt]=0}that.myBlocks[myModelId][block[0]].modelId=modelId;if(newModel==true){that.myBlocks[parentModelId][myParentBlock][that.modelIndex][index]=myModelId;that.myBlocks[parentModelId][myParentBlock][that.childIndex][index]=that.newModelConst;that.blockRegisteredURL[parentModelId][myurl]=false}that.blockCounter++;if(myPriority==true){that.priorityLoadingCounter--}that.loadingCounter--;that.dataLoaded=true;that.dataLoading=false;if(pauseTillLoaded==true){that.currentBlock=block[0]}}});if(newConnection==false){this.socket[socket].emit("chunk_request_"+db,{newConnection:newConnection,db:db,chunkId:chunkId,modelId:1,clientRequestId:this.clientRequestId,url:myurl})}else{this.socket[socket].emit("chunk_request",{newConnection:newConnection,db:db,chunkId:chunkId,modelId:1,clientRequestId:this.clientRequestId,url:myurl})}}}}}function precalcRay(e,t,n,r,i){this.parent=null;this.parent=[];this.currentBlock=this.magicBlock;this.currentModel=this.magicModel;this.modelList=null;this.modelList=[];this.modelList.push(this.currentModel);this.loopScaleMask=this.loopScaleOrigMask;this.edgeDetectMask=this.edgeDetectMaskOrig;var s=this.loopDetailOrig;var o=this.loopBlockOrig;var u=this.loopEdgeOrig;var a=this.invLoopBlockOrig;var f=this.loopStepOrig;var l=0;var c=0;var h=0;var p=false;var d=0;this.xShift=this.xShiftOrig;this.yShift=this.yShiftOrig;this.zShift=this.zShiftOrig;var v=Math.floor(Math.abs(this.eyeX));var m=Math.floor(Math.abs(this.eyeY));var g=Math.floor(Math.abs(this.eyeZ));var y=[];var b=[];var w=[];currentBlockMaskXcomp=v&this.edgeDetectMask;currentBlockMaskYcomp=m&this.edgeDetectMask;currentBlockMaskZcomp=g&this.edgeDetectMask;var E=[];var S=[];var x=[];var T=[];var N=[];var C=[];var k=[];var L=[];var A=[];var O=[];var M=[];var _=[];var D=[];var P=[];var H=[];var B=[];var j=[];var F=[];var I;if(this.dataLoaded==false||this.blockCounter==0){this.getKnownBlock(this.currentModel,this.magicBlock,0,true,false);return false}var q=this.raySpeedConst;var R=Math.floor(Math.floor(e*q));var U=Math.floor(Math.floor(t*q));var z=Math.floor(Math.floor(n*q));var W=Math.floor(Math.abs(R));var X=Math.floor(Math.abs(U));var V=Math.floor(Math.abs(z));var $,J;var K,Q;var G,Y;if(R>0){$=f;J=f}else{$=-f;J=0}if(U>0){K=f;Q=f}else{K=-f;Q=0}if(z>0){G=f;Y=f}else{G=-f;Y=0}if(this.framesDelay>500){}l=0;c=0;h=0;var Z=100;var et=v;var tt=m;var nt=g;var v=Math.floor(Math.abs(this.eyeX));var m=Math.floor(Math.abs(this.eyeY));var g=Math.floor(Math.abs(this.eyeZ));var rt=v&s;var it=m&s;var st=g&s;var ot=false;var ut=false;var at=false;var ft=this.eyeX;var lt=this.eyeY;var ct=this.eyeZ;var ht=0;var pt=1;l=0;c=0;h=0;var rt=v&s;var it=m&s;var st=g&s;var Z=100;var dt=1e3;if(Math.abs(z)<dt){var vt=Math.floor(Z*G);var mt=Math.floor(Z*G);var gt=Math.floor(G)}else{var yt=(G-z)/z;var vt=Math.floor(R*yt+R);var mt=Math.floor(U*yt+U);var gt=Math.floor(G)}if(Math.abs(R)<dt){var bt=Math.floor($);var wt=Math.floor(Z*$);var Et=Math.floor(Z*$)}else{var yt=($-R)/R;var bt=Math.floor($);var wt=Math.floor(U*yt+U);var Et=Math.floor(z*yt+z)}if(Math.abs(U)<dt){var St=Math.floor(Z*K);var xt=Math.floor(K);var Tt=Math.floor(Z*K)}else{var yt=(K-U)/U;var St=Math.floor(R*yt+R);var xt=Math.floor(K);var Tt=Math.floor(z*yt+z)}this.eachStepXDX[r][i]=bt;this.eachStepXDY[r][i]=wt;this.eachStepXDZ[r][i]=Et;this.eachStepYDX[r][i]=St;this.eachStepYDY[r][i]=xt;this.eachStepYDZ[r][i]=Tt;this.eachStepZDX[r][i]=vt;this.eachStepZDY[r][i]=mt;this.eachStepZDZ[r][i]=gt;var ht=0;var pt=1;while(pt!=0&&ht<this.maxScales){ht++;var Nt=(v&this.loopScaleMask)>>this.xShift;var Ct=(m&this.loopScaleMask)>>this.yShift;var kt=(g&this.loopScaleMask)>>this.zShift;var Lt=Nt+Ct+kt;if(ht>2){}pt=this.myBlocks[this.currentModel][this.currentBlock][this.colours][Lt];if(pt!=0){var At=this.myBlocks[this.currentModel][this.currentBlock][this.childIndex][Lt];if(isNaN(At)){this.getKnownBlock(this.currentModel,At,Lt,false,false);At=this.nullIndex}if(At==this.newModelConst){var Ot=this.currentModel;this.currentModel=this.myBlocks[this.currentModel][this.currentBlock][this.modelIndex][Lt];At=this.firstBlock}else{var Ot=false}if(At>0){if(this.myBlocks[this.currentModel][At]){this.currentBlock=At;d++;q=q>>this.scaleShift;R=R>>this.scaleShift;U=U>>this.scaleShift;z=z>>this.scaleShift;f=f>>this.scaleShift;o=o>>this.scaleShift;o=o+this.addAfterShiftRight;u=u>>this.scaleShift;a=a>>this.scaleShift;this.loopScaleMask=this.loopScaleMask>>this.scaleShift;this.xShift-=this.scaleShift;this.yShift-=this.scaleShift;this.zShift-=this.scaleShift;this.edgeDetectMask=this.edgeDetectMask>>this.scaleShift;this.edgeDetectMask=this.edgeDetectMask+this.addAfterShiftRight;currentBlockMaskXcomp=v&this.edgeDetectMask;currentBlockMaskYcomp=m&this.edgeDetectMask;currentBlockMaskZcomp=g&this.edgeDetectMask;vt=vt>>this.scaleShift;mt=mt>>this.scaleShift;gt=gt>>this.scaleShift;St=St>>this.scaleShift;xt=xt>>this.scaleShift;Tt=Tt>>this.scaleShift;bt=bt>>this.scaleShift;wt=wt>>this.scaleShift;Et=Et>>this.scaleShift;$=$>>this.scaleShift;K=K>>this.scaleShift;G=G>>this.scaleShift;J=J>>this.scaleShift;Q=Q>>this.scaleShift;Y=Y>>this.scaleShift;s=s>>this.scaleShift;rt=v&s;it=m&s;st=g&s}else{this.getKnownBlock(this.currentModel,At,Lt,false,false);pt=0}}else{pt=0}}}var dt=100;if(Math.abs(z)<dt){var Mt=Math.floor(Z*G);var _t=Math.floor(Z*G);var Dt=Math.floor(Y)}else{yt=(Y-st-z)/z;var Mt=Math.floor(rt+R+R*yt);var _t=Math.floor(it+U+U*yt);var Dt=Math.floor(st+z+z*yt);if(this.framesDelay>500){}}if(Math.abs(R)<dt){var Pt=Math.floor(J);var Ht=Math.floor(Z*$);var Bt=Math.floor(Z*$)}else{yt=(J-rt-R)/R;var Pt=Math.floor(rt+R+R*yt);var Ht=Math.floor(it+U+U*yt);var Bt=Math.floor(st+z+z*yt)}if(Math.abs(U)<dt){var jt=Math.floor(Z*K);var Ft=Math.floor(Z*K);var It=Math.floor(Q)}else{yt=(Q-it-U)/U;var jt=Math.floor(rt+R+R*yt);var Ft=Math.floor(it+U+U*yt);var It=Math.floor(st+z+z*yt)}if(this.framesDelay>500){}this.firstStepXDX[r][i]=Pt;this.firstStepXDY[r][i]=Ht;this.firstStepXDZ[r][i]=Bt;this.firstStepYDX[r][i]=jt;this.firstStepYDY[r][i]=Ft;this.firstStepYDZ[r][i]=It;this.firstStepZDX[r][i]=Mt;this.firstStepZDY[r][i]=_t;this.firstStepZDZ[r][i]=Dt}function stepThrough(e,t,n,i,s,o){if(this.framesDelay>500){alert("SX="+i+" SY="+s+" New Ray x:"+e+" Ray y:"+t+" Ray z:"+n)}this.parent=null;this.parent=[];this.currentBlock=this.magicBlock;this.currentModel=this.magicModel;this.modelList=null;this.modelList=[];this.modelList.push(this.currentModel);this.loopScaleMask=this.loopScaleOrigMask;this.edgeDetectMask=this.edgeDetectMaskOrig;var u=this.loopDetailOrig;var a=this.loopBlockOrig;var f=this.loopEdgeOrig;var l=this.invLoopBlockOrig;var c=this.loopStepOrig;var h=0;var p=0;var d=0;var v=false;var m=0;var y=this.pixelWidth;var w=this.pixelRate;this.xShift=this.xShiftOrig;this.yShift=this.yShiftOrig;this.zShift=this.zShiftOrig;var E=Math.floor(Math.abs(this.eyeX));var S=Math.floor(Math.abs(this.eyeY));var x=Math.floor(Math.abs(this.eyeZ));var T=[];var N=[];var C=[];currentBlockMaskXcomp=E&this.edgeDetectMask;currentBlockMaskYcomp=S&this.edgeDetectMask;currentBlockMaskZcomp=x&this.edgeDetectMask;T.push(currentBlockMaskXcomp);N.push(currentBlockMaskYcomp);C.push(currentBlockMaskZcomp);var k=[];var L=[];var A=[];var O=[];var M=[];var _=[];var D=[];var P=[];var H=[];var B=[];var j=[];var F=[];var I=[];var q=[];var R=[];var U=[];var z=[];var W=[];var X;if(this.dataLoaded==false||this.blockCounter==0){this.getKnownBlock(this.currentModel,this.magicBlock,0,true,o);return false}var V=this.raySpeedConst;var $=Math.floor(Math.floor(e));var J=Math.floor(Math.floor(t));var K=Math.floor(Math.floor(n));var Q,G;var Y,Z;var et,tt;if($>0){Q=c;G=c}else{Q=-c;G=0}if(J>0){Y=c;Z=c}else{Y=-c;Z=0}if(K>0){et=c;tt=c}else{et=-c;tt=0}if(this.framesDelay>500){console.log("rayX:"+e+" deepX:"+$+" rayY:"+t+" deepY:"+J+" rayZ:"+n+" deepZ:"+K+" StepZ="+et)}h=0;p=0;d=0;var nt=E&u;var rt=S&u;var it=x&u;var st=100;var ot=this.curEachStepXDX;var ut=this.curEachStepXDY;var at=this.curEachStepXDZ;var ft=this.curEachStepYDX;var lt=this.curEachStepYDY;var ct=this.curEachStepYDZ;var ht=this.curEachStepZDX;var pt=this.curEachStepZDY;var dt=this.curEachStepZDZ;var vt=this.curFirstStepXDX;var mt=this.curFirstStepXDY;var gt=this.curFirstStepXDZ;var yt=this.curFirstStepYDX;var bt=this.curFirstStepYDY;var wt=this.curFirstStepYDZ;var Et=this.curFirstStepZDX;var St=this.curFirstStepZDY;var xt=this.curFirstStepZDZ;if(this.framesDelay>500){if(!vt){console.log("Screen XY:"+i+" "+s+" First step XDX"+vt+" "+mt+" "+gt);console.log("First step YDX"+yt+" "+bt+" "+wt);console.log("First step ZDX"+Et+" "+St+" "+xt)}}var Tt=E;var Nt=S;var Ct=x;var kt=0;var Lt=1;while(Lt!=0&&kt<this.maxScales){kt++;var At=(E&this.loopScaleMask)>>this.xShift;var Ot=(S&this.loopScaleMask)>>this.yShift;var Mt=(x&this.loopScaleMask)>>this.zShift;var _t=At+Ot+Mt;if(kt>2){}Lt=this.myBlocks[this.currentModel][this.currentBlock][this.colours][_t];if(Lt!=0){var Dt=this.myBlocks[this.currentModel][this.currentBlock][this.childIndex][_t];if(isNaN(Dt)){this.getKnownBlock(this.currentModel,Dt,_t,false,o);Dt=this.nullIndex}if(Dt==this.newModelConst){var Pt=this.currentModel;this.currentModel=this.myBlocks[this.currentModel][this.currentBlock][this.modelIndex][_t];Dt=this.firstBlock}else{var Pt=false}if(Dt>0){if(this.myBlocks[this.currentModel][Dt]){this.parent.push(this.currentBlock);this.currentBlock=Dt;m++;if(Pt!=false){this.modelList.push(Pt)}else{this.modelList.push(this.currentModel)}V=V>>this.scaleShift;$=$>>this.scaleShift;J=J>>this.scaleShift;K=K>>this.scaleShift;c=c>>this.scaleShift;a=a>>this.scaleShift;a=a+this.addAfterShiftRight;f=f>>this.scaleShift;l=l>>this.scaleShift;w=w>>this.scaleShift;this.loopScaleMask=this.loopScaleMask>>this.scaleShift;this.xShift-=this.scaleShift;this.yShift-=this.scaleShift;this.zShift-=this.scaleShift;this.edgeDetectMask=this.edgeDetectMask>>this.scaleShift;this.edgeDetectMask=this.edgeDetectMask+this.addAfterShiftRight;T.push(currentBlockMaskXcomp);N.push(currentBlockMaskYcomp);C.push(currentBlockMaskZcomp);currentBlockMaskXcomp=E&this.edgeDetectMask;currentBlockMaskYcomp=S&this.edgeDetectMask;currentBlockMaskZcomp=x&this.edgeDetectMask;k.push(ht);L.push(pt);A.push(dt);O.push(ft);M.push(lt);_.push(ct);D.push(ot);P.push(ut);H.push(at);ht=ht>>this.scaleShift;pt=pt>>this.scaleShift;dt=dt>>this.scaleShift;ft=ft>>this.scaleShift;lt=lt>>this.scaleShift;ct=ct>>this.scaleShift;ot=ot>>this.scaleShift;ut=ut>>this.scaleShift;at=at>>this.scaleShift;Q=Q>>this.scaleShift;Y=Y>>this.scaleShift;et=et>>this.scaleShift;G=G>>this.scaleShift;Z=Z>>this.scaleShift;tt=tt>>this.scaleShift}else{this.getKnownBlock(this.currentModel,Dt,_t,false,o);Lt=0}}else{Lt=0}}}var i=Math.floor(E)&a;var s=Math.floor(S)&a;var Ht=Math.floor(x)&a;var Bt=i+Et;var jt=s+St;var Ft=Ht+xt;var It=i+vt;var qt=s+mt;var Rt=Ht+gt;var Ut=i+yt;var zt=s+bt;var Wt=Ht+wt;var Xt=false;var Vt=false;var $t=false;var Jt=this.eyeX;var Kt=this.eyeY;var Qt=this.eyeZ;var Gt=0;var Yt=false;var Zt=false;var en=false;var tn=0;var nn=Bt;var rn=jt;var sn=Ft;var on=It;var un=qt;var an=Rt;var fn=Ut;var ln=zt;var cn=Wt;var E=Math.floor(E)&a;var S=Math.floor(S)&a;var x=Math.floor(x)&a;var hn=Math.abs(nn-Jt)+Math.abs(sn-Qt)+Math.abs(rn-Kt);var pn=Math.abs(on-Jt)+Math.abs(an-Qt)+Math.abs(un-Kt);var dn=Math.abs(fn-Jt)+Math.abs(cn-Qt)+Math.abs(ln-Kt);if(hn<pn){if(hn<dn){Bt=nn;jt=rn;Ft=sn;Xt=true;Jt=Bt;Kt=jt;Qt=Ft;x=x+et}else{Ut=fn;zt=ln;Wt=cn;$t=true;Jt=Ut;Kt=zt;Qt=Wt;S=S+Y}}else{if(pn<dn){It=on;qt=un;Rt=an;Vt=true;Jt=It;Kt=qt;Qt=Rt;E=E+Q}else{Ut=fn;zt=ln;Wt=cn;$t=true;Jt=Ut;Kt=zt;Qt=Wt;S=S+Y}}var vn=0;var mn=false;var gn="";var yn=false;var bn=false;var wn=false;var En=[];var Sn=[];var xn=[];var Tn=this.myMaxDepth;if(this.framesDelay>500){console.log("Starting scale stepX:"+Q)}while(Gt<Tn&&Lt==0&&vn<this.maxDepth){vn++;if(vn>40){var Nn=true}if(this.framesDelay>500){console.log("x:"+E+" "+S+" "+x)}if(E<0||S<0||x<0){if(this.framesDelay>500){console.log("end of line - out of bounds");this.framesDelay=0}this.parent=null;this.modelList=null;k=null;L=null;A=null;O=null;M=null;_=null;D=null;P=null;H=null;B=null;j=null;F=null;I=null;q=null;R=null;U=null;z=null;W=null;T=null;N=null;C=null;this.rayWentDist=Gt;this.rayWentX=Jt;this.rayWentY=Kt;this.rayWentZ=Qt;this.moveOut+=m;return 0}en=true;while(en==true){en=false;var Cn=E&this.edgeDetectMask;var kn=S&this.edgeDetectMask;var Ln=x&this.edgeDetectMask;if(Cn!=currentBlockMaskXcomp||kn!=currentBlockMaskYcomp||Ln!=currentBlockMaskZcomp){var An=this.parent.pop();if(An){this.currentBlock=An;en=true;mn=true;V=V<<this.scaleShift;c=c<<this.scaleShift;this.loopScaleMask=this.loopScaleMask<<this.scaleShift;this.xShift+=this.scaleShift;this.yShift+=this.scaleShift;this.zShift+=this.scaleShift;this.edgeDetectMask=this.edgeDetectMask-this.addAfterShiftRight;this.edgeDetectMask=this.edgeDetectMask<<this.scaleShift;w=w<<this.scaleShift;this.currentModel=this.modelList.pop();if(this.framesDelay>500){alert("Scaling up. Just retrieved current model"+this.currentModel)}Vt=true;$t=true;Xt=true;Q=Q<<this.scaleShift;Y=Y<<this.scaleShift;et=et<<this.scaleShift;m--;a=a-this.addAfterShiftRight;a=a<<this.scaleShift;f=f<<this.scaleShift;var On=1;var Mn=Math.floor(Jt);var _n=Math.floor(Kt);var Dn=Math.floor(Qt);var Pn=0;var On=20;if((Mn&l)>l-On){if(Q>0){Mn=Mn+1+(l-(Mn&l))}else{}}if((_n&l)>l-On){if(Y>0){_n=_n+1+(l-(_n&l))}else{}}if((Dn&l)>l-On){if(et>0){Dn=Dn+1+(l-(Dn&l))}else{}}if((Mn&l)<On){if(Q>0){}else{Mn=Mn-(Mn&l)-1}}if((_n&l)<On){if(Y>0){}else{_n=_n-(_n&l)-1}}if((Dn&l)<On){if(et>0){}else{Dn=Dn-(Dn&l)-1}}if(wn==false){E=Mn&a;S=_n&a;x=Dn&a}else{En.push(E);Sn.push(S);xn.push(x);E=E&a;S=S&a;x=x&a}Jt=Mn;Kt=_n;Qt=Dn;if(B.length<=0){var Hn=0;var Bn=4;var jn=false;var On=20;if(dt>0){var Fn=x+f-On;if(this.framesDelay>500){console.log("Myzz "+Ft+" = "+Fn)}while(Ft<Fn&&Hn<Bn){Bt=Bt+ht;jt=jt+pt;Ft=Ft+dt;if(this.framesDelay>500){console.log("Each step ZDX = "+ht+"Each step ZDY = "+pt+"Each step ZDZ = "+dt);console.log("Move forward pos step till "+Ft+" = "+Fn)}jn=true;Hn++}if(this.framesDelay>500){console.log("Done pos step myZ="+Ft+"  compareZ="+Fn+" z:"+x+" loop edge: "+f)}}else{var Fn=x+On;while(Ft>Fn&&Hn<Bn){Bt=Bt+ht;jt=jt+pt;Ft=Ft+dt;if(this.framesDelay>500){console.log("Move forward till "+Ft+" = "+Fn)}jn=true;Hn++}if(this.framesDelay>500){console.log("Done myZ="+Ft+"  compareZ="+Fn)}}var Hn=0;var jn=false;if(ot>0){var In=E+f-On;while(It<In&&Hn<Bn){It=It+ot;qt=qt+ut;Rt=Rt+at;jn=true;Hn++}}else{var In=E+On;while(It>In&&Hn<Bn){It=It+ot;qt=qt+ut;Rt=Rt+at;jn=true;Hn++}}var Hn=0;var jn=false;if(lt>0){var qn=S+f-On;while(zt<qn&&Hn<Bn){Ut=Ut+ft;zt=zt+lt;Wt=Wt+ct;jn=true;Hn++}}else{var qn=S+On;while(zt>qn&&Hn<Bn){Ut=Ut+ft;zt=zt+lt;Wt=Wt+ct;jn=true;Hn++}}ht=k.pop();pt=L.pop();dt=A.pop();ft=O.pop();lt=M.pop();ct=_.pop();ot=D.pop();ut=P.pop();at=H.pop();if(ot>0){if(It>Jt){It=It-ot;qt=qt-ut;Rt=Rt-at}}else{if(It<Jt){It=It-ot;qt=qt-ut;Rt=Rt-at}}if(dt>0){if(Ft>Qt){Bt=Bt-ht;jt=jt-pt;Ft=Ft-dt}}else{if(Ft<Qt){Bt=Bt-ht;jt=jt-pt;Ft=Ft-dt}}if(lt>0){if(zt>Kt){Ut=Ut-ft;zt=zt-lt;Wt=Wt-ct}}else{if(zt<Kt){Ut=Ut-ft;zt=zt-lt;Wt=Wt-ct}}}else{ht=k.pop();pt=L.pop();dt=A.pop();ft=O.pop();lt=M.pop();ct=_.pop();ot=D.pop();ut=P.pop();at=H.pop();Bt=B.pop();jt=j.pop();Ft=F.pop();It=U.pop();qt=z.pop();Rt=W.pop();Ut=I.pop();zt=q.pop();Wt=R.pop();var Hn=0;var Bn=4;var On=1;if(dt>0){while(Ft<Qt-On&&Hn<Bn){Bt=Bt+ht;jt=jt+pt;Ft=Ft+dt;Hn++}if(Ft>Qt&&Hn>0){Bt=Bt-ht;jt=jt-pt;Ft=Ft-dt}}else{while(Ft>Qt+On&&Hn<Bn){Bt=Bt+ht;jt=jt+pt;Ft=Ft+dt;Hn++}if(Ft<Qt&&Hn>0){Bt=Bt-ht;jt=jt-pt;Ft=Ft-dt}}Hn=0;if(ot>0){while(It<Jt-On&&Hn<Bn){It=It+ot;qt=qt+ut;Rt=Rt+at;Hn++}if(It>Jt&&Hn>0){It=It-ot;qt=qt-ut;Rt=Rt-at}}else{while(It>Jt+On&&Hn<Bn){It=It+ot;qt=qt+ut;Rt=Rt+at;Hn++}if(It<Jt&&Hn>0){It=It-ot;qt=qt-ut;Rt=Rt-at}}Hn=0;if(lt>0){while(zt<Kt-On&&Hn<Bn){Ut=Ut+ft;zt=zt+lt;Wt=Wt+ct;Hn++}if(zt>Kt&&Hn>0){Ut=Ut-ft;zt=zt-lt;Wt=Wt-ct}}else{while(zt>Kt+On&&Hn<Bn){Ut=Ut+ft;zt=zt+lt;Wt=Wt+ct;Hn++}if(zt<Kt&&Hn>0){Ut=Ut-ft;zt=zt-lt;Wt=Wt-ct}}}On=6;var Rn;l=(l<<this.scaleShift)+3;currentBlockMaskXcomp=T.pop();currentBlockMaskYcomp=N.pop();currentBlockMaskZcomp=C.pop();yn=false;this.moveInOut++;this.moveOut++}else{if(this.framesDelay>500){console.log("end of line - out of world");this.framesDelay=0}this.depthAverage++;if(this.wrapWorld==false){this.parent=null;this.modelList=null;k=null;L=null;A=null;O=null;M=null;_=null;D=null;P=null;H=null;B=null;j=null;F=null;I=null;q=null;R=null;U=null;z=null;W=null;T=null;N=null;C=null;this.moveOut+=m;this.rayWentDist=Gt;this.rayWentX=Jt;this.rayWentY=Kt;this.rayWentZ=Qt;return 0}}}}var At=(E&this.loopScaleMask)>>this.xShift;var Ot=(S&this.loopScaleMask)>>this.yShift;var Mt=(x&this.loopScaleMask)>>this.zShift;var _t=At+Ot+Mt;if(!this.myBlocks[this.currentModel][this.currentBlock]){alert("mod"+this.currentModel+" block"+this.currentBlock)}else{Lt=this.myBlocks[this.currentModel][this.currentBlock][this.colours][_t]}if(this.twomap==true){var Un=2;var zn=50;var Wn=50;var Xn=19;this.bufferContext.fillText(E,(E>>Xn)+zn,(x>>Xn)+Wn);aminx=(E>>Xn)+zn;aminz=(x>>Xn)+Wn;amaxx=(E+Math.abs(Q)>>Xn)+zn;amaxz=(x+Math.abs(et)>>Xn)+Wn;for(ax=aminx;ax<amaxx;ax++){for(az=aminz;az<amaxz;az++){var Vn=az*this.width+ax<<Un;switch(m){case 0:var $n=128;break;case 1:var $n=64;break;case 2:var $n=32;break;default:var $n=16;break}if($n==64||$n==32||$n==128||$n==16){r=$n;g=$n;b=$n;this.imageData.data[Vn]=r;this.imageData.data[Vn+1]=g;this.imageData.data[Vn+2]=b;this.imageData.data[Vn+3]=128}}}ax=(It>>Xn)+zn;az=(Rt>>Xn)+Wn;var Vn=az*this.width+ax<<Un;r=0;g=255;b=255;this.imageData.data[Vn]=r;this.imageData.data[Vn+1]=g;this.imageData.data[Vn+2]=b;this.imageData.data[Vn+3]=255;ax=(Bt>>Xn)+zn;az=(Ft>>Xn)+Wn;var Vn=az*this.width+ax<<Un;r=255;g=0;b=255;this.imageData.data[Vn]=r;this.imageData.data[Vn+1]=g;this.imageData.data[Vn+2]=b;this.imageData.data[Vn+3]=255;ax=(this.eyeX>>Xn)+zn;az=(this.eyeZ>>Xn)+Wn;var Vn=az*this.width+ax<<Un;r=255;g=0;b=0;this.imageData.data[Vn]=r;this.imageData.data[Vn+1]=g;this.imageData.data[Vn+2]=b;this.imageData.data[Vn+3]=255;if(this.framesDelay>500){this.bufferContext.putImageData(this.imageData,0,0);ax=this.loopEdgeOrig*1;az=0;this.bufferContext.fillText(ax,(ax>>Xn)+zn,(az>>Xn)+Wn);ax=this.loopEdgeOrig*3;az=0;this.bufferContext.fillText(ax,(ax>>Xn)+zn,(az>>Xn)+Wn);ax=0;az=this.loopEdgeOrig*1;this.bufferContext.fillText(az,(ax>>Xn)+zn,(az>>Xn)+Wn);ax=0;az=this.loopEdgeOrig*3;this.bufferContext.fillText(az,(ax>>Xn)+zn,(az>>Xn)+Wn);this.outputContext.drawImage(this.buffer,0,0,this.outputWidth,this.outputHeight)}}if(this.framesDelay>500){console.log("px:"+Jt+" "+Kt+" "+Qt);var At=(E&this.loopScaleMask)>>this.xShift;var Ot=(S&this.loopScaleMask)>>this.xShift;var Mt=(x&this.loopScaleMask)>>this.xShift;console.log("Current model:"+this.currentModel);console.log("Current Block:"+this.currentBlock);console.log("An index check:"+At+" "+Ot+" "+Mt)}if(this.framesDelay>500){console.log("px:"+Jt+" "+Kt+" "+Qt);console.log("x:"+E+" "+S+" "+x);console.log("POINT PLOTTED");alert("point")}var Jn=false;if(this.framesDelay>500){console.log("currentPixelWidth"+y+" Loop block="+a)}if(Lt!=0&&y<f){var Dt=this.myBlocks[this.currentModel][this.currentBlock][this.childIndex][_t];if(isNaN(Dt)){this.getKnownBlock(this.currentModel,Dt,_t,false,o);Dt=this.nullIndex}if(Dt==this.newModelConst){var Pt=this.currentModel;this.currentModel=this.myBlocks[this.currentModel][this.currentBlock][this.modelIndex][_t];Dt=this.firstBlock}else{var Pt=false}if(Dt>0){if(this.myBlocks[this.currentModel][Dt]){this.parent.push(this.currentBlock);this.currentBlock=Dt;if(Pt!=false){this.modelList.push(Pt)}else{this.modelList.push(this.currentModel)}tn=Lt;m++;V=V>>this.scaleShift;c=c>>this.scaleShift;a=a>>this.scaleShift;a=a+this.addAfterShiftRight;f=f>>this.scaleShift;l=l>>this.scaleShift;var On=1;var Kn=f-1;var Pn=0;var Qn=0;var Gn=0;var Yn=0;var Mn=Math.floor(Jt);var _n=Math.floor(Kt);var Dn=Math.floor(Qt);var Zn=false;this.edgeDetectMask=this.edgeDetectMask>>this.scaleShift;this.edgeDetectMask=this.edgeDetectMask+this.addAfterShiftRight;T.push(currentBlockMaskXcomp);N.push(currentBlockMaskYcomp);C.push(currentBlockMaskZcomp);currentBlockMaskXcomp=E&this.edgeDetectMask;currentBlockMaskYcomp=S&this.edgeDetectMask;currentBlockMaskZcomp=x&this.edgeDetectMask;if(wn==false){E=Mn&a;S=_n&a;x=Dn&a}else{if(En.length>0){E=En.pop();S=Sn.pop();x=xn.pop()}else{E=Mn&a;S=_n&a;x=Dn&a;Zn=true}}if(Mn<0){E=-1}if(_n<0){S=-1}if(Dn<0){x=-1}this.loopScaleMask=this.loopScaleMask>>this.scaleShift;this.xShift-=this.scaleShift;this.yShift-=this.scaleShift;this.zShift-=this.scaleShift;var On=20;if((Mn&l)>l-On){if(Q>0){Mn=Mn+1+(l-(Mn&l))}else{}}if((_n&l)>l-On){if(Y>0){_n=_n+1+(l-(_n&l))}else{}}if((Dn&l)>l-On){if(et>0){Dn=Dn+1+(l-(Dn&l))}else{}}if((Mn&l)<On){if(Q>0){}else{Mn=Mn-(Mn&l)-1}}if((_n&l)<On){if(Y>0){}else{_n=_n-(_n&l)-1}}if((Dn&l)<On){if(et>0){}else{Dn=Dn-(Dn&l)-1}}It=Math.floor(It);qt=Math.floor(qt);Rt=Math.floor(Rt);Ut=Math.floor(Ut);zt=Math.floor(zt);Wt=Math.floor(Wt);Bt=Math.floor(Bt);jt=Math.floor(jt);Ft=Math.floor(Ft);if(wn==false){E=Mn&a;S=_n&a;x=Dn&a}else{if(Zn==true){E=Mn&a;S=_n&a;x=Dn&a}}if(Mn<0){E=-1}if(_n<0){S=-1}if(Dn<0){x=-1}var On=6;var er=0;var tr=l>>this.scaleShift;var nr=0;var rr=false;var ir=false;var sr=false;k.push(ht);L.push(pt);A.push(dt);O.push(ft);M.push(lt);_.push(ct);D.push(ot);P.push(ut);H.push(at);ht=ht>>this.scaleShift;pt=pt>>this.scaleShift;dt=dt>>this.scaleShift;ft=ft>>this.scaleShift;lt=lt>>this.scaleShift;ct=ct>>this.scaleShift;ot=ot>>this.scaleShift;ut=ut>>this.scaleShift;at=at>>this.scaleShift;w=w>>this.scaleShift;Q=Q>>this.scaleShift;Y=Y>>this.scaleShift;et=et>>this.scaleShift;B.push(Bt);j.push(jt);F.push(Ft);U.push(It);z.push(qt);W.push(Rt);I.push(Ut);q.push(zt);R.push(Wt);Vt=true;$t=true;Xt=true;if(this.framesDelay>500){console.log("Before move forwards myZX:"+Bt+" "+jt+" "+Ft+" myXX:"+It+" "+qt+" "+Rt+" myYX:"+Ut+" "+zt+" "+Wt+" ");console.log("fpz:"+Dn+" fpy:"+_n+" fpx:"+Mn)}var jn=false;var Hn=0;var Bn=4;var or=0;var On=0;Jt=Mn;Kt=_n;Qt=Dn;if(dt>0){if(Ft<Qt){while(Ft<Qt&&Hn<Bn){Bt=Bt+ht;jt=jt+pt;Ft=Ft+dt;jn=true;Hn++}if(Ft>Qt+On&&jn==true){Bt=Bt-ht;jt=jt-pt;Ft=Ft-dt}}else{while(Ft>Qt+On&&Hn<Bn){Bt=Bt-ht;jt=jt-pt;Ft=Ft-dt;jn=true;Hn++}}}else{if(Ft>Qt){while(Ft>Qt&&Hn<Bn){Bt=Bt+ht;jt=jt+pt;Ft=Ft+dt;jn=true;Hn++}if(Ft<Qt-On&&jn==true){Bt=Bt-ht;jt=jt-pt;Ft=Ft-dt}}else{while(Ft<Qt-On&&Hn<Bn){Bt=Bt-ht;jt=jt-pt;Ft=Ft-dt;Hn++}}}var Hn=0;var jn=false;var or=0;if(ot>0){if(It<Jt){while(It<Jt&&Hn<Bn){It=It+ot;qt=qt+ut;Rt=Rt+at;Hn++;jn=true}if(It>Jt+On&&jn==true){It=It-ot;qt=qt-ut;Rt=Rt-at}}else{while(It>Jt+On&&Hn<Bn){It=It-ot;qt=qt-ut;Rt=Rt-at;jn=true;Hn++}}}else{if(It>Jt){while(It>Jt&&Hn<Bn){It=It+ot;qt=qt+ut;Rt=Rt+at;jn=true;Hn++}if(It<Jt-On&&jn==true){It=It-ot;qt=qt-ut;Rt=Rt-at}}else{while(It<Jt-On&&Hn<Bn){It=It-ot;qt=qt-ut;Rt=Rt-at;jn=true;Hn++}}}var Hn=0;var jn=false;var or=0;var Hn=0;var jn=false;if(lt>0){if(zt<Kt){while(zt<Kt&&Hn<Bn){Ut=Ut+ft;zt=zt+lt;Wt=Wt+ct;jn=true;Hn++}if(zt>Kt+On&&jn==true){Ut=Ut-ft;zt=zt-lt;Wt=Wt-ct}}else{while(zt>Kt+On&&Hn<Bn){Ut=Ut-ft;zt=zt-lt;Wt=Wt-ct;jn=true;Hn++}}}else{if(zt>Kt){while(zt>Kt&&Hn<Bn){Ut=Ut+ft;zt=zt+lt;Wt=Wt+ct;jn=true;Hn++}if(zt<Kt-On&&jn==true){Ut=Ut-ft;zt=zt-lt;Wt=Wt-ct}}else{while(zt<Kt-On&&Hn<Bn){Ut=Ut-ft;zt=zt-lt;Wt=Wt-ct;jn=true;Hn++}}}Zt=true;justSteppedIn=true;this.moveInOut++;this.moveIn++;Lt=0;myEdgeDetect=this.edgeDetectMask;var Cn=E&myEdgeDetect;var kn=S&myEdgeDetect;var Ln=x&myEdgeDetect;if(Cn!=currentBlockMaskXcomp||kn!=currentBlockMaskYcomp||Ln!=currentBlockMaskZcomp||rr==true){}}else{this.getKnownBlock(this.currentModel,Dt,_t,false,o);Jn=true}}else{Jn=true}}else{Zt=false}mn=false;if(Zt==false&&Jn==false){wn=false;y=y+w;if(this.framesDelay>500){alert("currentPixelWidth"+y+" loopBlock "+a+" currentPixelRate "+w)}if(this.framesDelay>500){console.log("Stepping myZX:"+Bt+" "+jt+" "+Ft+" myXX:"+It+" "+qt+" "+Rt)}if(Xt==true){var nn=Bt+ht;var rn=jt+pt;var sn=Ft+dt}else{var nn=Bt;var rn=jt;var sn=Ft}if(Vt==true){var on=It+ot;var un=qt+ut;var an=Rt+at}else{var on=It;var un=qt;var an=Rt}if($t==true){var fn=Ut+ft;var ln=zt+lt;var cn=Wt+ct}else{var fn=Ut;var ln=zt;var cn=Wt}var hn=Math.abs(nn-Jt)+Math.abs(sn-Qt)+Math.abs(rn-Kt);var pn=Math.abs(on-Jt)+Math.abs(an-Qt)+Math.abs(un-Kt);var dn=Math.abs(fn-Jt)+Math.abs(cn-Qt)+Math.abs(ln-Kt);var ur=false;if(this.framesDelay>500){console.log("Comparison with compare ZX"+nn+" "+rn+" "+sn+" YX"+fn+" "+ln+" "+cn+"XX:"+on+" "+un+" "+an)}if(hn<pn){if(hn<dn){Bt=nn;jt=rn;Ft=sn;Jt=Bt;Kt=jt;Qt=Ft;x=x+et;if(this.framesDelay>500){console.log("z =z + "+et)}gn="z";Xt=true}else{Ut=fn;zt=ln;Wt=cn;Jt=Ut;Kt=zt;Qt=Wt;S=S+Y;if(this.framesDelay>500){console.log("y =y + "+Y)}gn="y";$t=true}}else{if(pn<dn){It=on;qt=un;Rt=an;Jt=It;Kt=qt;Qt=Rt;E=E+Q;gn="x";if(this.framesDelay>500){console.log("x =x + "+Q)}Vt=true}else{Ut=fn;zt=ln;Wt=cn;Jt=Ut;Kt=zt;Qt=Wt;S=S+Y;gn="y";if(this.framesDelay>500){console.log("y =y + "+Y)}$t=true}}if(this.framesDelay>500){console.log("New px:"+Jt+" "+Kt+" "+Qt)}Tt=Tt+$;Nt=Nt+J;Ct=Ct+K}else{}this.depthAverage++;Gt+=V}if(this.framesDelay>500){console.log("End of line colour:"+Lt);this.framesDelay=0}if(this.twomap==true){}this.parent=null;this.modelList=null;k=null;L=null;A=null;O=null;M=null;_=null;D=null;P=null;H=null;B=null;j=null;F=null;I=null;q=null;R=null;U=null;z=null;W=null;T=null;N=null;C=null;this.rayWentDist=Gt;this.rayWentX=Jt;this.rayWentY=Kt;this.rayWentZ=Qt;return Lt}function precalcRayDelta(e,t){if(e>=this.xPreCalc){var n=this.xPreCalc+1}else{var n=e+1}this.firstStepXDXDelta[e][t]=this.firstStepXDX[n][t]-this.firstStepXDX[e][t]>>this.PreCalcApproxShift;this.firstStepXDYDelta[e][t]=this.firstStepXDY[n][t]-this.firstStepXDY[e][t]>>this.PreCalcApproxShift;this.firstStepXDZDelta[e][t]=this.firstStepXDZ[n][t]-this.firstStepXDZ[e][t]>>this.PreCalcApproxShift;this.firstStepYDXDelta[e][t]=this.firstStepYDX[n][t]-this.firstStepYDX[e][t]>>this.PreCalcApproxShift;this.firstStepYDYDelta[e][t]=this.firstStepYDY[n][t]-this.firstStepYDY[e][t]>>this.PreCalcApproxShift;this.firstStepYDZDelta[e][t]=this.firstStepYDZ[n][t]-this.firstStepYDZ[e][t]>>this.PreCalcApproxShift;this.firstStepZDXDelta[e][t]=this.firstStepZDX[n][t]-this.firstStepZDX[e][t]>>this.PreCalcApproxShift;this.firstStepZDYDelta[e][t]=this.firstStepZDY[n][t]-this.firstStepZDY[e][t]>>this.PreCalcApproxShift;this.firstStepZDZDelta[e][t]=this.firstStepZDZ[n][t]-this.firstStepZDZ[e][t]>>this.PreCalcApproxShift;this.eachStepXDXDelta[e][t]=this.eachStepXDX[n][t]-this.eachStepXDX[e][t]>>this.PreCalcApproxShift;this.eachStepXDYDelta[e][t]=this.eachStepXDY[n][t]-this.eachStepXDY[e][t]>>this.PreCalcApproxShift;this.eachStepXDZDelta[e][t]=this.eachStepXDZ[n][t]-this.eachStepXDZ[e][t]>>this.PreCalcApproxShift;this.eachStepYDXDelta[e][t]=this.eachStepYDX[n][t]-this.eachStepYDX[e][t]>>this.PreCalcApproxShift;this.eachStepYDYDelta[e][t]=this.eachStepYDY[n][t]-this.eachStepYDY[e][t]>>this.PreCalcApproxShift;this.eachStepYDZDelta[e][t]=this.eachStepYDZ[n][t]-this.eachStepYDZ[e][t]>>this.PreCalcApproxShift;this.eachStepZDXDelta[e][t]=this.eachStepZDX[n][t]-this.eachStepZDX[e][t]>>this.PreCalcApproxShift;this.eachStepZDYDelta[e][t]=this.eachStepZDY[n][t]-this.eachStepZDY[e][t]>>this.PreCalcApproxShift;this.eachStepZDZDelta[e][t]=this.eachStepZDZ[n][t]-this.eachStepZDZ[e][t]>>this.PreCalcApproxShift}function stepRayCalcs(e,t){var n=e>>this.PreCalcApproxShift;if(n!=this.lastIsx){this.curFirstStepXDX=this.firstStepXDX[n][t];this.curFirstStepXDXDelta=this.firstStepXDXDelta[n][t];this.curFirstStepXDY=this.firstStepXDY[n][t];this.curFirstStepXDYDelta=this.firstStepXDYDelta[n][t];this.curFirstStepXDZ=this.firstStepXDZ[n][t];this.curFirstStepXDZDelta=this.firstStepXDZDelta[n][t];this.curFirstStepYDX=this.firstStepYDX[n][t];this.curFirstStepYDXDelta=this.firstStepYDXDelta[n][t];this.curFirstStepYDY=this.firstStepYDY[n][t];this.curFirstStepYDYDelta=this.firstStepYDYDelta[n][t];this.curFirstStepYDZ=this.firstStepYDZ[n][t];this.curFirstStepYDZDelta=this.firstStepYDZDelta[n][t];this.curFirstStepZDX=this.firstStepZDX[n][t];this.curFirstStepZDXDelta=this.firstStepZDXDelta[n][t];this.curFirstStepZDY=this.firstStepZDY[n][t];this.curFirstStepZDYDelta=this.firstStepZDYDelta[n][t];this.curFirstStepZDZ=this.firstStepZDZ[n][t];this.curFirstStepZDZDelta=this.firstStepZDZDelta[n][t];this.curEachStepXDX=this.eachStepXDX[n][t];this.curEachStepXDXDelta=this.eachStepXDXDelta[n][t];this.curEachStepXDY=this.eachStepXDY[n][t];this.curEachStepXDYDelta=this.eachStepXDYDelta[n][t];this.curEachStepXDZ=this.eachStepXDZ[n][t];this.curEachStepXDZDelta=this.eachStepXDZDelta[n][t];this.curEachStepYDX=this.eachStepYDX[n][t];this.curEachStepYDXDelta=this.eachStepYDXDelta[n][t];this.curEachStepYDY=this.eachStepYDY[n][t];this.curEachStepYDYDelta=this.eachStepYDYDelta[n][t];this.curEachStepYDZ=this.eachStepYDZ[n][t];this.curEachStepYDZDelta=this.eachStepYDZDelta[n][t];this.curEachStepZDX=this.eachStepZDX[n][t];this.curEachStepZDXDelta=this.eachStepZDXDelta[n][t];this.curEachStepZDY=this.eachStepZDY[n][t];this.curEachStepZDYDelta=this.eachStepZDYDelta[n][t];this.curEachStepZDZ=this.eachStepZDZ[n][t];this.curEachStepZDZDelta=this.eachStepZDZDelta[n][t]}else{this.curFirstStepXDX+=this.curFirstStepXDXDelta;this.curFirstStepXDY+=this.curFirstStepXDYDelta;this.curFirstStepXDZ+=this.curFirstStepXDZDelta;this.curFirstStepYDX+=this.curFirstStepYDXDelta;this.curFirstStepYDY+=this.curFirstStepYDYDelta;this.curFirstStepYDZ+=this.curFirstStepYDZDelta;this.curFirstStepZDX+=this.curFirstStepZDXDelta;this.curFirstStepZDY+=this.curFirstStepZDYDelta;this.curFirstStepZDZ+=this.curFirstStepZDZDelta;this.curEachStepXDX=this.curEachStepXDX+this.curEachStepXDXDelta;this.curEachStepXDY=this.curEachStepXDY+this.curEachStepXDYDelta;this.curEachStepXDZ=this.curEachStepXDZ+this.curEachStepXDZDelta;this.curEachStepYDX=this.curEachStepYDX+this.curEachStepYDXDelta;this.curEachStepYDY=this.curEachStepYDY+this.curEachStepYDYDelta;this.curEachStepYDZ=this.curEachStepYDZ+this.curEachStepYDZDelta;this.curEachStepZDX=this.curEachStepZDX+this.curEachStepZDXDelta;this.curEachStepZDY=this.curEachStepZDY+this.curEachStepZDYDelta;this.curEachStepZDZ=this.curEachStepZDZ+this.curEachStepZDZDelta}this.lastIsx=n}function plotScreenScaler(){var e=new Date;if(this.twomap==true){for(p=0;p<this.width*this.height*4;p+=4){w=255,E=255;S=255;this.imageData.data[p]=w;this.imageData.data[p+1]=E;this.imageData.data[p+2]=S;this.imageData.data[p+3]=255}}if(this.spinning==true&&this.rotateAroundX){this.spin(this.spinUpDown,this.spinLeftRight,0)}this.eyeX=this.moveToX;this.eyeY=this.moveToY;this.eyeZ=this.moveToZ;this.mouseInRotatePos(this.sx,this.sy);var t=this.rotate3D(this.pitch,this.yaw,this.roll,0,0,this.lookDist);this.lookX=t[0];this.lookY=t[1];this.lookZ=t[2];this.stayInWorldBounds();this.raysDirection();screenIndex=0;this.depthAverage=0;this.moveInOut=0;var n=this.lookX+this.width/2*-this.stepXacr+this.height/2*-this.stepXdown;var r=this.lookY+this.width/2*-this.stepYacr+this.height/2*-this.stepYdown;var i=this.lookZ+this.width/2*-this.stepZacr+this.height/2*-this.stepZdown;var s=this.stepXacr*this.PreCalcApprox;var o=this.stepYacr*this.PreCalcApprox;var u=this.stepZacr*this.PreCalcApprox;for(var a=0;a<this.height;a++){var f=n;var l=r;var c=i;for(var h=0;h<this.xPreCalc+2;h++){if(this.precalcRay(f,l,c,h,a)==false){}f+=s;l+=o;c+=u}n+=this.stepXdown;r+=this.stepYdown;i+=this.stepZdown}for(var a=0;a<this.height;a++){for(var h=0;h<this.xPreCalc+1;h++){this.precalcRayDelta(h,a)}}for(var p=0;p<10;p++){var d=Math.random()*this.width;var v=Math.random()*this.height;randSX=d-this.width/2;randSY=v-this.height/2;var f=this.lookX+randSX*-this.stepXacr+randSY*-this.stepXdown;var l=this.lookY+randSX*-this.stepYacr+randSY*-this.stepYdown;var c=this.lookZ+randSX*-this.stepZacr+randSY*-this.stepZdown;if(this.twomap==false){if(d<this.width&&v<this.height){var m=d>>this.PreCalcApproxShift<<this.PreCalcApproxShift;this.stepRayCalcs(m,Math.floor(v));if(this.dataLoaded==true){this.stepThrough(f,l,c,Math.floor(m),Math.floor(v),true)}}}}var n=this.lookX+this.width/2*-this.stepXacr+this.height/2*-this.stepXdown;var r=this.lookY+this.width/2*-this.stepYacr+this.height/2*-this.stepYdown;var i=this.lookZ+this.width/2*-this.stepZacr+this.height/2*-this.stepZdown;for(var a=0;a<this.height;a++){var f=n;var l=r;var c=i;if(a>=0&&a<this.yraysStart+this.yrays){this.lastIsx=-1;for(var h=0;h<this.width;h++){if(h>=0&&h<this.xraysStart+this.xrays){if(this.twomap==true){if(h>=this.xraysStart&&a>=this.yraysStart){if(this.framesDelay>500){console.log("sx:"+h+"sy:"+a)}var g=h%this.PreCalcApprox;var y=h>>this.PreCalcApproxShift<<this.PreCalcApproxShift;this.stepRayCalcs(y,a);for(p=0;p<g;p++){this.stepRayCalcs(y+p,a)}if(this.dataLoaded==true){var b=this.stepThrough(f,l,c,h,a,false)}}}else{this.stepRayCalcs(h,a);if(this.dataLoaded==true){var b=this.stepThrough(f,l,c,h,a,false)}}}if(h==this.xraysStart&&a==this.yraysStart){b=4292005314}if(this.mouseDown==true){if(this.zoomToSX==h&&this.zoomToSY==a){this.zoomDist=this.rayWentDist;if(b!=0){this.spinX=this.rayWentX;this.spinY=this.rayWentY;this.spinZ=this.rayWentZ}else{this.zoomDist=this.zoomDist*.1}}}if(b==0){b=4292005314}var w=b&255;var E=(b&65280)>>8;var S=(b&16711680)>>16;if(this.twomap==false){this.imageData.data[screenIndex]=w;this.imageData.data[screenIndex+1]=E;this.imageData.data[screenIndex+2]=S;this.imageData.data[screenIndex+3]=255}screenIndex+=4;f+=this.stepXacr;l+=this.stepYacr;c+=this.stepZacr}}n+=this.stepXdown;r+=this.stepYdown;i+=this.stepZdown}this.depthFinalAverage=this.depthAverage/(this.width*this.height);this.moveInOutFinalAverage=this.moveInOut/(this.width*this.height);this.start++;this.bufferContext.putImageData(this.imageData,0,0);if(this.twoMap==true){this.bufferContext.fillText("Colour "+b,10,10);this.bufferContext.fillText("Eye X "+this.eyeX+" Y "+this.eyeY+" Z "+this.eyeZ,10,20);this.bufferContext.fillText("Look X "+this.lookX+" Y "+this.lookY+" Z "+this.lookZ,10,30);var T=2;var N=50;var C=50;var k=19;x=this.loopEdgeOrig*1;z=0;this.bufferContext.fillText(x,(x>>k)+N,(z>>k)+C);x=this.loopEdgeOrig*3;z=0;this.bufferContext.fillText(x,(x>>k)+N,(z>>k)+C);x=0;z=this.loopEdgeOrig*1;this.bufferContext.fillText(z,(x>>k)+N,(z>>k)+C);x=0;z=this.loopEdgeOrig*3;this.bufferContext.fillText(z,(x>>k)+N,(z>>k)+C)}if(this.viewTech==true){this.bufferContext.fillText("Yaw "+this.yaw,10,50);this.bufferContext.fillText("Pitch "+this.yaw,10,60);this.bufferContext.fillText("Look X "+Math.floor(this.lookX)+" Y "+Math.floor(this.lookY)+" Z "+Math.floor(this.lookZ),10,40);this.bufferContext.fillText("EX "+Math.floor(this.eyeX),10,10);this.bufferContext.fillText("EY "+Math.floor(this.eyeY),10,20);this.bufferContext.fillText("EZ "+Math.floor(this.eyeZ),10,30)}this.outputContext.drawImage(this.buffer,0,0,this.outputWidth,this.outputHeight);this.framesDelay+=this.framesDelayDiff;if(this.serverSide==true){console.log(this.frames+"\n");if(this.frames>=this.framesTillExport){if(this.frames<=this.framesToExport+this.framesTillExport){var L=this.fs.createWriteStream(this.outputDirectory+"/spinner"+(this.frames-this.framesTillExport)+".png");var A=this.canvasServerSide.createPNGStream();console.log("Saving started");A.on("data",function(e){L.write(e)});that=this;A.on("end",function(){console.log("Saving finished "+that.savingPNG);that.savingPNG++;if(that.savingPNG>=that.framesToExport+1){console.log("Exit");process.exit(0);return}})}else{return}}this.frames++}this.rotating=false;var O=new Date;this.frameTime=O-e;if(this.loopType!="rotation"){this.maxSpinSpeed=.12/((this.frameTime+1e-4)/1e3)}that=this;if(this.realityHasFocus==true){setTimeout(function(){that.plotScreenScaler()},40)}return}function stayInWorldBounds(){if(this.eyeZ>this.loopScaleOrigMask){this.eyeZ=this.loopScaleOrigMask}if(this.eyeZ<0){this.eyeZ=0}if(this.eyeX>this.loopScaleOrigMask){this.eyeX=this.loopScaleOrigMask}if(this.eyeX<0){this.eyeX=0}if(this.eyeY>this.loopScaleOrigMask){this.eyeY=this.loopScaleOrigMask}if(this.eyeY<0){this.eyeY=0}}function stayInWorldBoundsGeneric(e,t,n){var r=false;if(n>this.loopScaleOrigMask){n=this.loopScaleOrigMask;r=true}if(n<0){n=0;r=true}if(e>this.loopScaleOrigMask){e=this.loopScaleOrigMask;r=true}if(e<0){e=0;r=true}if(t>this.loopScaleOrigMask){t=this.loopScaleOrigMask;r=true}if(t<0){t=0;r=true}var i=[];i[0]=e;i[1]=t;i[2]=n;i[3]=r;return i}function processKeypress(e,t){var t=e.keyCode;var n=String.fromCharCode(t);if(t=="37"){n="a";e.preventDefault()}if(t=="39"){n="d";e.preventDefault()}if(t=="38"){n="w";e.preventDefault()}if(t=="40"){n="s";e.preventDefault()}if(t=="33"){n="1";e.preventDefault()}if(t=="34"){n="2";e.preventDefault()}this.processKeyPressInCanvas(e,n)}function processKeyPressInCanvas(e,t){if(!t){var n=e.keyCode;var t=String.fromCharCode(n)}var r=15*256*16*(this.frameTime/1e3);var i=.02;var s=this.maxSpinSpeed;if(this.twomap==true){i=5e-4}switch(t){case"w":if(this.spinning==true){this.spinUpDown=s;this.spinLeftRight=0}else{this.moveToZ=this.eyeZ+this.lookZ*r;this.moveToX=this.eyeX+this.lookX*r}break;case"s":if(this.spinning==true){this.spinUpDown=-s;this.spinLeftRight=0}else{this.moveToZ=this.eyeZ-this.lookZ*r;this.moveToX=this.eyeX-this.lookX*r}break;case"a":if(this.spinning==true){this.spinLeftRight=-s;this.spinUpDown=0}else{this.yaw+=i}break;case"d":if(this.spinning==true){this.spinLeftRight=s;this.spinUpDown=0}else{this.yaw+=-i}break;case"1":if(this.pitch>-(Math.PI/2)){this.pitch-=i}else{this.pitch=-Math.PI/2}break;case"2":if(this.pitch<Math.PI/2){this.pitch+=i}else{this.pitch=Math.PI/2}break;case"6":alert("Look Z:"+this.lookZ+" Look Y:"+this.lookY+" LookX:"+this.lookX+"Rotating:"+this.rotating);break;case"R":this.moveToY=this.eyeY+=5e3*256*16;break;case"F":this.moveToY=this.eyeY-5e3*256*16;break;case"p":this.pause();break;case"t":this.debug=true;break;case"0":this.framesDelay=6e3;break;case"i":this.raySpeedConst+=5;break;case"u":this.raySpeedConst-=5;break;case"V":console.log("Eye X:"+this.eyeX+" Eye Z"+this.eyeZ+" Look X"+this.lookX+" Look Z"+this.lookZ+" Average depth: "+this.depthFinalAverage+" Moving in/out of scale average: "+this.moveInOutFinalAverage+" Ray speed const:"+this.raySpeedConst+" this.stepXacr"+this.stepXacr+" this.stepYacr"+this.stepYacr+" this.stepZacr"+this.stepZacr+" Move in total="+this.moveIn+" Move out total="+this.moveOut);this.viewTech=true;break;case"b":console.log("this.firstStepYDX"+this.firstStepYDX+"this.firstStepYDY"+this.firstStepYDY+"this.firstStepYDZ"+this.firstStepYDZ+"this.eachStepYDX"+this.eachStepYDX+"this.eachStepYDY"+this.eachStepYDY+"this.eachStepYDZ"+this.eachStepYDZ);break;case"m":if(this.showMap==false){this.showMap=true;this.twomap=true;this.yrays=1;this.xrays=1}else{this.showMap=false;this.twomap=false;this.yraysStart=0;this.xraysStart=0;this.yrays=200;this.xrays=300}break;case"g":this.colourWrong=true;break}}function cancelEvent(e){if(!e)e=window.event;if(e.preventDefault){e.preventDefault()}else{e.returnValue=false}}function prepareScreen(e){if(!e.eyeX){}else{this.eyeX=e.eyeX;this.eyeY=e.eyeY;this.eyeZ=e.eyeZ;this.moveToX=this.eyeX;this.moveToY=this.eyeY;this.moveToZ=this.eyeZ}if(!e.yaw){}else{this.yaw=e.yaw;this.pitch=e.pitch;this.roll=e.roll}if(!e.parentServer){this.parentServer="http://127.0.0.1:10000"}else{this.parentServer=e.parentServer}if(!e.parentDatabase){this.parentDatabase="voxel_parent"}else{this.parentDatabase=e.parentDatabase}this.socket=[];this.newModel=[];this.newModel[1]=true;this.clientRequestId=1;this.uniqueModelDbPerServer=[];this.uniqueModelDbPerServer[1]=[];this.uniqueModelDbPerServer[1][this.parentDatabase]=true;this.uniqueServer=[];this.uniqueServer[this.parentServer]=1;this.dbSocketCnt=1;this.socketCnt=1;this.modelSocket=[];this.modelDb=[];if(!e.outputWidth){this.outputWidth=600;this.outputHeight=400;this.width=300;this.height=200;this.yrays=200;this.xrays=300}else{this.outputWidth=e.outputWidth;this.outputHeight=e.outputHeight;this.width=e.raysWidth;this.height=e.raysHeight;this.xrays=e.raysWidth;this.yrays=e.raysHeight}this.xRatio=this.outputWidth/this.width;this.yRatio=this.outputHeight/this.height;this.screenSizeRatio=140/this.width;this.xPreCalc=Math.floor(this.xrays/this.PreCalcApprox);this.yPreCalc=this.yrays;this.maxDepth=120;var t;if(e.serverSide){this.serverSide=true;t=e.serverSide;this.canvas=t;this.canvasServerSide=e.serverSide;this.fs=e.fileSystem;this.framesTillExport=e.framesTillExport;this.framesToExport=e.framesToExport;this.frames=0;this.savingPNG=0;this.outputDirectory=e.outputDirectory}else{this.serverSide=false;if(e.canvas){var n=e.canvas}else{var n="reality"}t=document.getElementById(n);this.canvas=t;var r=this;t.addEventListener("mousedown",function(t){return r.ev_mousedown(t)},false);t.addEventListener("mouseup",function(t){return r.ev_mouseup(t)},false);t.addEventListener("mousemove",function(t){return r.processMouseover(t,r)},false);t.addEventListener("mouseout",function(t){return r.ev_mouseout(t)},false);t.addEventListener("dragstart",function(e){cancelEvent(e)});t.addEventListener("selectstart",function(e){cancelEvent(e)});t.addEventListener("touchstart",function(t){return r.ev_touchstart(t)},false);t.addEventListener("touchmove",function(t){return r.ev_touchmove(t)},false);t.addEventListener("touchend",function(t){return r.ev_touchend(t)},false);t.addEventListener("onkeydown",function(t){return r.processKeypressInCanvas(t)});document.onkeydown=function(t){return r.processKeypress(t)}}this.outputContext=t.getContext("2d");if(e.loopType){this.loopType=e.loopType;if(this.loopType=="rotation"){this.rotateAroundX=e.rotateX;this.rotateAroundY=e.rotateY;this.rotateAroundZ=e.rotateZ;this.spinLeftRight=e.angleRotatePerFrame;this.maxSpinSpeed=this.spinLeftRight;this.spinUpDown=0;this.rotateAroundFixed=true;this.spinning=true;this.aliasing=false}}else{this.loopType="interactive";this.aliasing=true}if(e.serverSide){var i=new e.canvasDefine(this.width,this.height)}else{var i=document.createElement("canvas");i.width=this.width;i.height=this.height}this.bufferContext=i.getContext("2d");this.buffer=i;this.imageData=this.bufferContext.createImageData(this.width,this.height);this.lastSX=this.width/2;this.lastSY=this.height/2;this.lastFrameSX=this.lastSX;this.lastFrameSY=this.lastSY;this.lastControlsSX=this.lastSX;this.lastControlsSY=this.lastSY;this.blockRegistered[2]=[];if(e.serverSide==false){this.determineCursorType("zoom")}if(this.aliasing==true){this.raysDirection();this.pixelWidth=Math.floor(Math.abs(this.stepXacr+this.stepZacr+this.stepYacr)/3*this.raySpeedConst);this.pixelRate=Math.floor(2097151*this.width/200)}else{this.pixelWidth=0;this.pixelRate=0}for(var s=0;s<=this.xPreCalc+1;s++){this.firstStepXDX[s]=new Array(this.yPreCalc);this.firstStepXDY[s]=new Array(this.yPreCalc);this.firstStepXDZ[s]=new Array(this.yPreCalc);this.firstStepYDX[s]=new Array(this.yPreCalc);this.firstStepYDY[s]=new Array(this.yPreCalc);this.firstStepYDZ[s]=new Array(this.yPreCalc);this.firstStepZDX[s]=new Array(this.yPreCalc);this.firstStepZDY[s]=new Array(this.yPreCalc);this.firstStepZDZ[s]=new Array(this.yPreCalc);this.eachStepXDX[s]=new Array(this.yPreCalc);this.eachStepXDY[s]=new Array(this.yPreCalc);this.eachStepXDZ[s]=new Array(this.yPreCalc);this.eachStepYDX[s]=new Array(this.yPreCalc);this.eachStepYDY[s]=new Array(this.yPreCalc);this.eachStepYDZ[s]=new Array(this.yPreCalc);this.eachStepZDX[s]=new Array(this.yPreCalc);this.eachStepZDY[s]=new Array(this.yPreCalc);this.eachStepZDZ[s]=new Array(this.yPreCalc);this.firstStepXDXDelta[s]=new Array(this.yPreCalc);this.firstStepXDYDelta[s]=new Array(this.yPreCalc);this.firstStepXDZDelta[s]=new Array(this.yPreCalc);this.firstStepYDXDelta[s]=new Array(this.yPreCalc);this.firstStepYDYDelta[s]=new Array(this.yPreCalc);this.firstStepYDZDelta[s]=new Array(this.yPreCalc);this.firstStepZDXDelta[s]=new Array(this.yPreCalc);this.firstStepZDYDelta[s]=new Array(this.yPreCalc);this.firstStepZDZDelta[s]=new Array(this.yPreCalc);this.eachStepXDXDelta[s]=new Array(this.yPreCalc);this.eachStepXDYDelta[s]=new Array(this.yPreCalc);this.eachStepXDZDelta[s]=new Array(this.yPreCalc);this.eachStepYDXDelta[s]=new Array(this.yPreCalc);this.eachStepYDYDelta[s]=new Array(this.yPreCalc);this.eachStepYDZDelta[s]=new Array(this.yPreCalc);this.eachStepZDXDelta[s]=new Array(this.yPreCalc);this.eachStepZDYDelta[s]=new Array(this.yPreCalc);this.eachStepZDZDelta[s]=new Array(this.yPreCalc)}}function pause(e){clearTimeout(this.pauseMe)}function getScreenXY(e){var t,n;var r=0;var i=0;var s=e.target;do{r+=s.offsetLeft;i+=s.offsetTop}while(s=s.offsetParent);var t;var n;if(e.pageX||e.pageY){t=e.pageX;n=e.pageY}else{var o=document.documentElement?document.documentElement.scrollTop:document.body.scrollTop;t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;n=e.clientY+document.body.scrollTop+o}t-=r;n-=i;var u=[t,n];return u}function mouseInRotatePos(e,t){var n=.2*(this.frameTime/1e3);var r=4;var i=5;var s=4;var o=this.lastFrameSX;var u=this.lastFrameSY;if(this.mouseOut==false){if(this.mouseDown==true){if(Math.abs(o-e)>s){this.spinning=true;this.moveToX=this.eyeX;this.moveToY=this.eyeY;this.moveToZ=this.eyeZ}if(Math.abs(u-t)>s){this.spinning=true;this.moveToX=this.eyeX;this.moveToY=this.eyeY;this.moveToZ=this.eyeZ}}if(this.spinning==false){if(e<this.outputWidth/i){this.yaw+=n;this.rotating=true}if(e>this.outputWidth-this.outputWidth/i){this.yaw+=-n;this.rotating=true}if(t>this.outputHeight-this.outputHeight/i){if(this.pitch<Math.PI/2){this.pitch+=n}else{this.pitch=Math.PI/2}this.rotating=true}if(t<this.outputHeight/i){if(this.pitch>-(Math.PI/2)){this.pitch-=n}else{this.pitch=-Math.PI/2}this.rotating=true}}else{this.spinLeftRight=0;this.spinUpDown=0;var a=o-e;var f=u-t;if(Math.abs(a)>Math.abs(f)){if(o-e>0){this.spinLeftRight=this.maxSpinSpeed;this.spinUpDown=0}if(o-e<0){this.spinLeftRight=-this.maxSpinSpeed;this.spinUpDown=0}}else{if(u-t<0){this.spinLeftRight=0;this.spinUpDown=this.maxSpinSpeed}if(u-t>0){this.spinLeftRight=0;this.spinUpDown=-this.maxSpinSpeed}}}}this.lastFrameSX=e;this.lastFrameSY=t}function ev_mouseout(e){this.mouseOut=true;this.mouseDown=false;this.spinning=false;this.spinUpDown=0;this.spinLeftRight=0;this.rotateAroundFixed=false}function processMouseover(e){this.mouseOut=false;var t=5;coords=this.getScreenXY(e);this.sx=coords[0];this.sy=coords[1];var n=false;if(this.spinning==true){this.determineCursorType("move")}else{if(this.sx<this.outputWidth/t){if(this.cursor!="w-resize"){this.determineCursorType("w-resize")}n=true}if(this.sx>this.outputWidth-this.outputWidth/t){if(this.cursor!="e-resize"){this.determineCursorType("e-resize")}n=true}if(this.sy>this.outputHeight-this.outputHeight/t){if(this.cursor!="s-resize"){this.determineCursorType("s-resize")}n=true}if(this.sy<this.outputHeight/t){if(this.cursor!="n-resize"){this.determineCursorType("n-resize")}n=true}if(this.cursor!="zoom"&&n==false){this.determineCursorType("zoom")}}}function ev_mouseclick(e){coords=this.getScreenXY(e);var t=coords[0];var n=coords[1]}function repositionTouch(e){var t;var n;if(e.targetTouches.length==1){var r=e.targetTouches[0];t=r.pageX;n=r.pageY;var i=t-this.touchLastX;var s=n-this.touchLastY;this.touchLastX=t;this.touchLastY=n;if(i<0){this.yaw+=rotate;this.rotating=true}if(i>0){this.yaw+=-rotate;this.rotating=true}if(s<0){if(this.pitch<Math.PI/2){this.pitch+=rotate}else{this.pitch=Math.PI/2}this.rotating=true}if(s>0){if(this.pitch>-(Math.PI/2)){this.pitch-=rotate}else{this.pitch=-Math.PI/2}this.rotating=true}e.preventDefault();return false}if(e.targetTouches.length==2){t=(e.targetTouches[0].pageX+e.targetTouches[1].pageX)/2;n=(e.targetTouches[0].pageY+e.targetTouches[1].pageY)/2;var i=t-this.touchLastX;var s=n-this.touchLastY;this.touchLastX=t;this.touchLastY=n;dist=Math.abs(e.targetTouches[0].pageX-e.targetTouches[1].pageX)+Math.abs(e.targetTouches[0].pageY-e.targetTouches[1].pageY);e.preventDefault();return false}}function ev_touchstart(e){this.touch=true;if(e.targetTouches.length==1){var t=e.targetTouches[0];this.touchLastX=t.pageX;this.touchLastY=t.pageY}if(e.targetTouches.length==2){this.touchLastX=(e.targetTouches[0].pageX+e.targetTouches[1].pageX)/2;this.touchLastY=(e.targetTouches[0].pageY+e.targetTouches[1].pageY)/2}this.repositionTouch(e)}function ev_touchmove(e){this.repositionTouch(e)}function ev_touchend(e){}function determineCursorType(e){this.cursor=e;if(e!="zoom"){if(jQuery.browser.mozilla){this.canvas.style.cursor=e}else if(jQuery.browser.safari){this.canvas.style.cursor=e}else{this.canvas.style.cursor=e}}else{if(jQuery.browser.mozilla){this.canvas.style.cursor="-moz-zoom-in"}else if(jQuery.browser.safari){this.canvas.style.cursor="-webkit-zoom-in"}else{this.canvas.style.cursor="url('http://rvolve.com/images/magnify_plus.cur')"}}}function ev_mousedown(e){coords=this.getScreenXY(e);this.zoomToSX=Math.floor(coords[0]/this.xRatio);this.zoomToSY=Math.floor(coords[1]/this.yRatio);try{this.lastSX=coords[0];this.lastSY=coords[1];this.sx=coords[0];this.sy=coords[1];this.lastControlsSX=this.sx;this.lastControlsSY=this.sy;this.lastFrameSX=this.sx;this.lastFrameSY=this.sy;var t=this.zoomToSX;var n=this.zoomToSY;randSX=-(t-this.width/2);randSY=-(n-this.height/2);this.zoomX=this.lookX+randSX*-this.stepXacr+randSY*-this.stepXdown;this.zoomY=this.lookY+randSX*-this.stepYacr+randSY*-this.stepYdown;this.zoomZ=this.lookZ+randSX*-this.stepZacr+randSY*-this.stepZdown;this.mouseDown=true}catch(e){}return false}function ev_mouseup(e){try{this.mouseDown=false;this.spinning=false;this.spinUpDown=0;this.spinLeftRight=0;this.rotateAroundFixed=false}catch(e){}}function respondToControls(){var e=this.sx;var t=this.sy;var n=4;if(this.mouseDown==true){lastSx=this.lastControlsSX;lastSy=this.lastControlsSY;if(Math.abs(lastSx-e)>n){this.spinning=true}if(Math.abs(lastSy-t)>n){this.spinning=true}}this.lastControlsSX=e;this.lastControlsSY=t;if(this.zoomDist>this.raySpeedConst/300){this.zoomDistFromSolid=this.zoomDist/100;var r=15*256*(this.frameTime/1e3);if(this.mouseDown==true&&this.zoomX&&this.spinning==false){this.moveToX=this.eyeX+r*this.zoomDistFromSolid*this.zoomX;this.moveToY=this.eyeY+r*this.zoomDistFromSolid*this.zoomY;this.moveToZ=this.eyeZ+r*this.zoomDistFromSolid*this.zoomZ}}if(this.mouseDown==true&&this.spinning==true){if(this.rotateAroundFixed==false){if(this.spinX){this.rotateAroundFixed=true;this.rotateAroundX=this.spinX;this.rotateAroundY=this.spinY;this.rotateAroundZ=this.spinZ}else{this.spinning=false}}}}function spin(e,t,n){var r,i,s;r=this.eyeX-this.rotateAroundX;i=this.eyeY-this.rotateAroundY;s=this.eyeZ-this.rotateAroundZ;if(e!=0){var o=-Math.atan2(r,s);var u=this.rotate3D(0,o,n,r,i,s);var u=this.rotate3D(-e,t,n,u[0],u[1],u[2]);var u=this.rotate3D(0,-o,n,u[0],u[1],u[2])}else{var u=this.rotate3D(e,t,n,r,i,s)}r=u[0];i=u[1];s=u[2];var a=r+this.rotateAroundX;var f=i+this.rotateAroundY;var l=s+this.rotateAroundZ;var c=this.stayInWorldBoundsGeneric(a,f,l);a=c[0];f=c[1];l=c[2];r=a-this.rotateAroundX;i=f-this.rotateAroundY;s=l-this.rotateAroundZ;if(r>0){var h=Math.atan2(-r,-s)}else{var h=-Math.PI+Math.atan2(r,s)}if(s<=0){var p=-Math.atan2(-i*Math.cos(h),-s)}else{var p=Math.atan2(-i*Math.cos(h),s)}var d=.05;var v=true;if(p>=Math.PI/2-d){p=Math.PI/2-d;v=false}if(p<=-Math.PI/2+d){p=-Math.PI/2+d;v=false}if(h>0){h=h-2*Math.PI}if(h<-(2*Math.PI)){h=h+2*Math.PI}var m=this.maxSpinSpeed;if(Math.abs(this.yaw-h)>Math.PI){this.yaw=h}else{if(h>this.yaw){this.yaw+=m;if(this.yaw>h){this.yaw=h}}else{this.yaw-=m;if(this.yaw<h){this.yaw=h}}}if(p>this.pitch){this.pitch+=m;if(this.pitch>p){this.pitch=p}}else{this.pitch-=m;if(this.pitch<p){this.pitch=p}}if(v==true){this.moveToX=a;this.moveToY=f;this.moveToZ=l}this.roll=0}function startRendering(){if(this.serverSide){console.log("Starting rendering")}var e=this;this.respondControlsTimer=setInterval(function(){e.respondToControls()},100);this.pauseMe=setTimeout(function(){e.plotScreenScaler()},40)}function mainLoop(e){if(e){io=e;this.io=io}if(typeof io==="undefined"){this.serverConnected=false;if(this.serverSide){console.log("Sorry, no connection to "+this.parentServer)}else{this.bufferContext.fillText("Sorry, no connection to",10,10);this.bufferContext.fillText(this.parentServer,10,20);this.outputContext.drawImage(this.buffer,0,0,this.outputWidth,this.outputHeight)}return}else{if(this.serverSide){console.log("Trying to connect to "+this.parentServer)}this.socket[1]=io.connect(this.parentServer,{"connect timeout":5e3});var t=this;this.socket[1].on("connect",function(){if(this.serverSide){console.log("Connected to "+this.parentServer)}t.serverConnected=true;startedReality=true;t.startRendering();return});this.socket[1].on("disconnect",function(){t.socket[1]=io.connect(t.parentServer,{"connect timeout":1e4});var e=t;t.socket[1].on("connect",function(){e.loadingCounter=0;for(block in e.blockRegistered){for(chunk in e.blockRegistered[block]){block=parseInt(block);chunk=parseInt(chunk);if(e.blockRegistered[block][chunk]==true){e.blockRegistered[block][chunk]=null}}}e.reconnectedSocket[e.magicModel]=true})});this.socket[1].on("connect_failed",function(){t.serverConnected=false;if(t.serverSide){console.log("Sorry, no connection to "+t.parentServer)}else{t.bufferContext.fillText("Sorry, no connection to",10,10);t.bufferContext.fillText(t.parentServer,10,20);t.outputContext.drawImage(t.buffer,0,0,t.outputWidth,t.outputHeight)}return})}return}this.mainLoop=mainLoop;this.prepareScreen=prepareScreen;this.pause=pause;this.raysDirection=raysDirection;this.ev_mouseclick=ev_mouseclick;this.ev_mousedown=ev_mousedown;this.ev_mouseup=ev_mouseup;this.ev_mouseout=ev_mouseout;this.cancelEvent=cancelEvent;this.getScreenXY=getScreenXY;this.onBlur=onRealityBlur;this.onFocus=onRealityFocus;this.respondToControls=respondToControls;this.processKeypress=processKeypress;this.processKeyPressInCanvas=processKeyPressInCanvas;this.processMouseover=processMouseover;this.start=0;this.precalcRay=precalcRay;this.precalcRayDelta=precalcRayDelta;this.rotate3D=rotate3D;this.determineCursorType=determineCursorType;this.eyeX=495938928;this.eyeY=8192e4;this.eyeZ=415036496;this.lookX=0;this.lookY=0;this.lookZ=-300;this.lookDist=300;this.yaw=Math.PI;this.pitch=0;this.roll=0;this.voxelBasic=[];this.stepXacr=0;this.stepYacr=0;this.stepZacr=0;this.stepXdown=0;this.stepYdown=0;this.stepZdown=0;this.blockCounter=0;this.maxScale=32;this.stepThrough=stepThrough;this.plotScreenScaler=plotScreenScaler;this.dataLoaded=false;this.dataLoading=false;this.scaleMask=520093696;this.outputShift=32;this.myBlocks=[];this.loopScaleOrigMask=805306368;this.loopStepOrig=268435456;this.edgeDetectMaskOrig=1073741824;this.loopBlockOrig=1879048192;this.addAfterShiftRight=1610612736;this.subAfterShiftLeft=1879048192;this.loopDetailOrig=268435455;this.loopEdgeOrig=268435456;this.invLoopBlockOrig=1073741823;this.xShiftOrig=28;this.yShiftOrig=26;this.zShiftOrig=24;this.maxScales=24;this.getKnownBlock=getKnownBlock;this.loopScale=this.maxScale;this.loopScaleMask=this.loopScaleOrigMask;this.edgeDetectMask=~this.loopScaleMask;this.chunkSize=4;this.scaleShift=2;this.xShift=28;this.yShift=26;this.zShift=24;this.currentBlock=0;this.parent=[];this.colours=1;this.childIndex=2;this.modelIndex=3;this.loadingCounter=0;this.priorityLoadingCounter=0;this.blockRegistered=[];this.debug=false;this.depthFinalAverage;this.depthAverage;this.moveInOut;this.moveOut=0;this.moveIn=0;this.moveInOutFinalAverage;this.raySpeedConst=130*16;this.rotate=rotate;this.stayInWorldBounds=stayInWorldBounds;this.framesDelay=0;this.framesDelayDiff=0;this.colourWrong=false;this.showMap=false;if(this.showMap==true){this.twomap=true;this.yraysStart=0;this.xraysStart=0;this.yrays=1;this.xrays=1}else{this.twomap=false;this.yraysStart=0;this.xraysStart=0;this.yrays=200;this.xrays=300}this.wrapWorld=false;this.PreCalcApprox=8;this.PreCalcApproxShift=3;this.lastIsx=-1;this.stepRayCalcs=stepRayCalcs;this.firstStepXDX=[];this.firstStepXDY=[];this.firstStepXDZ=[];this.firstStepYDX=[];this.firstStepYDY=[];this.firstStepYDZ=[];this.firstStepZDX=[];this.firstStepZDY=[];this.firstStepZDZ=[];this.eachStepXDX=[];this.eachStepXDY=[];this.eachStepXDZ=[];this.eachStepYDX=[];this.eachStepYDY=[];this.eachStepYDZ=[];this.eachStepZDX=[];this.eachStepZDY=[];this.eachStepZDZ=[];this.firstStepXDXDelta=[];this.firstStepXDYDelta=[];this.firstStepXDZDelta=[];this.firstStepYDXDelta=[];this.firstStepYDYDelta=[];this.firstStepYDZDelta=[];this.firstStepZDXDelta=[];this.firstStepZDYDelta=[];this.firstStepZDZDelta=[];this.eachStepXDXDelta=[];this.eachStepXDYDelta=[];this.eachStepXDZDelta=[];this.eachStepYDXDelta=[];this.eachStepYDYDelta=[];this.eachStepYDZDelta=[];this.eachStepZDXDelta=[];this.eachStepZDYDelta=[];this.eachStepZDZDelta=[];this.curEachStepXDX=0;this.curEachStepXDXDelta=0;this.curEachStepXDY=0;this.curEachStepXDYDelta=0;this.curEachStepXDZ=0;this.curEachStepXDZDelta=0;this.curEachStepYDX=0;this.curEachStepYDXDelta=0;this.curEachStepYDY=0;this.curEachStepYDYDelta=0;this.curEachStepYDZ=0;this.curEachStepYDZDelta=0;this.curEachStepZDX=0;this.curEachStepZDXDelta=0;this.curEachStepZDY=0;this.curEachStepZDYDelta=0;this.curEachStepZDZ=0;this.curFirstStepZDZDelta=0;this.modelCounter=1;this.currentModel=1;this.magicModel=this.currentModel;this.indInChunk=this.chunkSize*this.chunkSize*this.chunkSize;this.nullIndex=-1;this.newModelConst=-2;this.modelList=[];this.myBlocks[this.currentModel]=[];this.magicBlock=1;this.blockRegisteredURL=[];this.blockRegisteredURL[this.currentModel]=[];this.blockRegistered[this.currentModel]=[];this.modelURL=[];this.firstBlock=1;this.reconnectedSocket=[];this.mouseDown=false;this.zoomToSX=-1;this.zoomToSY=-1;this.zoomX=0;this.zoomY=0;this.zoomZ=0;this.rayWentDist=0;this.zoomDist=0;this.moveToX=this.eyeX;this.moveToY=this.eyeY;this.moveToZ=this.eyeZ;this.mouseInRotatePos=mouseInRotatePos;this.cursor="zoom";this.determineCursorType=determineCursorType;this.pixelWidth=0;this.pixelRate=0;this.waitingOnChunk=[];this.frameTime=1e3;this.realityHasFocus=true;this.spin=spin;this.spinYaw=.2;this.spinning=false;this.rotateAroundFixed=false;this.spinUpDown=0;this.spinLeftRight=0;this.stayInWorldBoundsGeneric=stayInWorldBoundsGeneric;this.viewTech=false;this.serverConnected=false;this.startRendering=startRendering;this.myMaxDepth=this.raySpeedConst*20*16;this.ev_touchstart=ev_touchstart;this.ev_touchmove=ev_touchmove;this.ev_touchend=ev_touchend;this.repositionTouch=repositionTouch;if(typeof window==="undefined"){}else{if(!window.console)console={};console.log=console.log||function(){};console.warn=console.warn||function(){};console.error=console.error||function(){};console.info=console.info||function(){}}};var startedReality=false;if(false){document.onfocusin=onRealityFocus;document.onfocusout=onRealityBlur}else{if(typeof window==="undefined"){module.exports.reality=reality}else{window.onfocus=onRealityFocus;window.onblur=onRealityBlur}}
